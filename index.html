<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kingdom Defense Pro - Juego de Estrategia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a192f, #1a365d);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        
        h1 {
            color: #00d4ff;
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.7);
        }
        
        .game-area {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .game-board {
            flex: 3;
            min-width: 300px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #00d4ff;
            position: relative;
        }
        
        .game-info {
            flex: 1;
            min-width: 250px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #ff6b00;
        }
        
        #gameCanvas {
            width: 100%;
            height: 600px;
            background: #0f3460;
            border-radius: 10px;
            border: 2px solid #00d4ff;
            display: block;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
            cursor: crosshair;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: rgba(255, 107, 0, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 0, 0.3);
        }
        
        .stat-item {
            text-align: center;
            padding: 0 10px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #ff6b00;
            text-shadow: 0 0 10px rgba(255, 107, 0, 0.5);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            background: linear-gradient(45deg, #00d4ff, #0099ff);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 150px;
            justify-content: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-premium {
            background: linear-gradient(45deg, #ff6b00, #ff3d00);
        }
        
        .btn-premium:hover {
            box-shadow: 0 5px 15px rgba(255, 107, 0, 0.4);
        }
        
        .towers {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .tower-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .tower-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }
        
        .tower-card.selected {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }
        
        .tower-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
        }
        
        .tower-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #00d4ff;
        }
        
        .tower-cost {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.2rem;
            margin: 5px 0;
        }
        
        .tower-stats {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 5px;
        }
        
        .shop {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            border: 2px solid #9d4edd;
        }
        
        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .shop-item {
            background: rgba(157, 78, 221, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .shop-item:hover {
            background: rgba(157, 78, 221, 0.3);
            transform: translateY(-2px);
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #00d4ff;
        }
        
        .enemy-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 0, 0, 0.1);
            border-radius: 5px;
        }
        
        .enemy-icon {
            font-size: 1.5rem;
        }
        
        .wave-info {
            background: rgba(0, 212, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .wave-progress {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .wave-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #0099ff);
            width: 0%;
            transition: width 0.3s;
        }
        
        .game-over {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .game-over-content {
            background: linear-gradient(135deg, #0f3460, #1a365d);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 3px solid #00d4ff;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
        }
        
        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
            }
            
            .towers {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn {
                min-width: 100%;
            }
        }
        
        .status-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            border: 2px solid #00d4ff;
            z-index: 1000;
            display: none;
            font-weight: bold;
            text-align: center;
            max-width: 80%;
        }
    </style>
</head>
<body>
    <div class="status-message" id="statusMessage"></div>
    
    <div class="container">
        <header>
            <h1>üè∞ KINGDOM DEFENSE PRO</h1>
            <p>Juego de Estrategia - Defiende tu reino</p>
        </header>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-label">üí∞ ORO</div>
                <div class="stat-value" id="gold">1000</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">‚öîÔ∏è OLEADA</div>
                <div class="stat-value" id="wave">1</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">‚ù§Ô∏è VIDAS</div>
                <div class="stat-value" id="lives">30</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">üéØ PUNTOS</div>
                <div class="stat-value" id="points">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">üíé GEMAS</div>
                <div class="stat-value" id="gems">50</div>
            </div>
        </div>
        
        <div class="game-area">
            <div class="game-board">
                <canvas id="gameCanvas" width="800" height="600"></canvas>
                
                <div class="controls">
                    <button class="btn" id="startWave">
                        <span>‚ñ∂Ô∏è</span> Iniciar Oleada (1-10)
                    </button>
                    <button class="btn" id="upgradeAll">
                        <span>‚ö°</span> Mejorar Todas (200 oro)
                    </button>
                    <button class="btn" id="sellTower">
                        <span>üí∞</span> Vender Torre (75%)
                    </button>
                    <button class="btn btn-premium" id="specialPower">
                        <span>‚ú®</span> Poder Especial (10 gemas)
                    </button>
                </div>
                
                <div class="wave-info">
                    <h3>üìä Progreso de Oleada</h3>
                    <div class="wave-progress">
                        <div class="wave-progress-bar" id="waveProgress"></div>
                    </div>
                    <p id="waveStatus">Selecciona una torre y haz clic en una zona verde para construir</p>
                </div>
            </div>
            
            <div class="game-info">
                <h2 style="color: #00d4ff; margin-bottom: 15px;">üèóÔ∏è CONSTRUIR TORRES</h2>
                <p style="color: #aaa; margin-bottom: 15px;">Haz clic en una torre para seleccionarla, luego haz clic en una zona verde del mapa</p>
                
                <div class="towers">
                    <div class="tower-card" data-tower="archer" data-cost="150">
                        <div class="tower-icon">üèπ</div>
                        <div class="tower-name">Arquero √âlite</div>
                        <div class="tower-cost">150 ü™ô</div>
                        <div class="tower-stats">üéØ Da√±o: 25 ‚ö° Vel: R√°pida</div>
                    </div>
                    
                    <div class="tower-card" data-tower="mage" data-cost="300">
                        <div class="tower-icon">üîÆ</div>
                        <div class="tower-name">Mago Arcano</div>
                        <div class="tower-cost">300 ü™ô</div>
                        <div class="tower-stats">üéØ Da√±o: 40 ‚ö° Vel: Media</div>
                    </div>
                    
                    <div class="tower-card" data-tower="cannon" data-cost="400">
                        <div class="tower-icon">üí£</div>
                        <div class="tower-name">Ca√±√≥n Pesado</div>
                        <div class="tower-cost">400 ü™ô</div>
                        <div class="tower-stats">üéØ Da√±o: 65 ‚ö° Vel: Lenta</div>
                    </div>
                    
                    <div class="tower-card" data-tower="ice" data-cost="250">
                        <div class="tower-icon">‚ùÑÔ∏è</div>
                        <div class="tower-name">Torre Glacial</div>
                        <div class="tower-cost">250 ü™ô</div>
                        <div class="tower-stats">üéØ Da√±o: 15 ‚ö° Ralentiza</div>
                    </div>
                </div>
                
                <div class="instructions">
                    <h3 style="color: #ff6b00; margin-bottom: 10px;">üéÆ C√ìMO JUGAR</h3>
                    <ul style="list-style: none; padding-left: 0;">
                        <li style="margin-bottom: 8px;">‚úÖ <strong>Zonas verdes</strong> = Para construir torres</li>
                        <li style="margin-bottom: 8px;">‚úÖ <strong>Camino marr√≥n</strong> = Por donde vienen los enemigos</li>
                        <li style="margin-bottom: 8px;">‚úÖ <strong>Construye estrat√©gicamente</strong> para cubrir el camino</li>
                        <li style="margin-bottom: 8px;">‚úÖ <strong>Mejora torres</strong> para m√°s da√±o y alcance</li>
                        <li style="margin-bottom: 8px;">‚úÖ <strong>Sobrevive 10 oleadas</strong> para ganar</li>
                    </ul>
                </div>
                
                <div class="enemy-info">
                    <div class="enemy-icon">üëπ</div>
                    <div>
                        <div><strong>Enemigos Activos:</strong> <span id="enemyCount">0</span></div>
                        <div><strong>Siguiente oleada:</strong> <span id="nextWaveTimer">--</span>s</div>
                    </div>
                </div>
                
                <div class="shop">
                    <h2 style="color: #9d4edd; margin-bottom: 15px;">üõí TIENDA PREMIUM</h2>
                    
                    <div class="shop-items">
                        <div class="shop-item" id="buyGold">
                            <div style="font-size: 1.8rem; color: #ffd700;">ü™ô</div>
                            <div>+500 Oro</div>
                            <div style="margin: 8px 0; color: #9d4edd;">5 üíé</div>
                        </div>
                        
                        <div class="shop-item" id="buyLives">
                            <div style="font-size: 1.8rem; color: #ff4444;">‚ù§Ô∏è</div>
                            <div>+10 Vidas</div>
                            <div style="margin: 8px 0; color: #9d4edd;">8 üíé</div>
                        </div>
                        
                        <div class="shop-item" id="buyDamage">
                            <div style="font-size: 1.8rem; color: #00d4ff;">‚ö°</div>
                            <div>x2 Da√±o 30s</div>
                            <div style="margin: 8px 0; color: #9d4edd;">15 üíé</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.4); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
            <p>üéÆ <strong>Juego de estrategia</strong> - Defiende tu reino de las oleadas enemigas</p>
            <p style="font-size: 0.9rem; margin-top: 10px; color: #aaa;">Desarrollado con HTML5 Canvas y JavaScript</p>
        </div>
    </div>
    
    <!-- Pantalla de Game Over -->
    <div class="game-over" id="gameOver">
        <div class="game-over-content">
            <h2 id="gameOverTitle" style="color: #00d4ff; margin-bottom: 20px;">üèÜ ¬°VICTORIA!</h2>
            <div id="victoryIcon" style="font-size: 5rem; margin: 20px 0;">üëë</div>
            <p id="gameOverMessage" style="margin-bottom: 20px;">Has completado todas las oleadas</p>
            
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
                <div style="font-size: 2.5rem; color: #ffd700; margin: 10px 0;" id="finalScore">0 Puntos</div>
                <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                    <div>
                        <div style="color: #aaa;">Oleadas</div>
                        <div style="color: #00d4ff; font-size: 1.5rem;" id="finalWaves">0</div>
                    </div>
                    <div>
                        <div style="color: #aaa">Torres</div>
                        <div style="color: #00d4ff; font-size: 1.5rem;" id="finalTowers">0</div>
                    </div>
                    <div>
                        <div style="color: #aaa">Enemigos</div>
                        <div style="color: #00d4ff; font-size: 1.5rem;" id="finalEnemies">0</div>
                    </div>
                </div>
            </div>
            
            <div style="margin: 30px 0;">
                <button class="btn" id="playAgain" style="margin: 5px;">
                    <span>üîÑ</span> Jugar Otra Vez
                </button>
                <button class="btn btn-premium" id="continueGame" style="margin: 5px;">
                    <span>üöÄ</span> Continuar (Oleadas 11-20)
                </button>
            </div>
            
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px;">
                <p>¬øQuieres registrar tu r√©cord?</p>
                <button class="btn" id="shareScore" style="width: 100%; margin-top: 10px;">
                    <span>üì§</span> Compartir Puntaje
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // JUEGO COMPLETAMENTE CORREGIDO - CONSTRUCCI√ìN FUNCIONAL
        // ============================================
        
        // Variables del juego
        let gold = 1000;
        let wave = 1;
        let lives = 30;
        let points = 0;
        let gems = 50;
        let gameRunning = false;
        let selectedTower = null;
        let towers = [];
        let enemies = [];
        let bullets = [];
        let enemyKills = 0;
        let maxWaves = 10;
        let waveTimer = 0;
        let specialPowerActive = false;
        let damageBoostActive = false;
        let damageBoostEndTime = 0;
        
        // Definir expl√≠citamente las posiciones donde SE PUEDEN CONSTRUIR TORRES
        // Estas son zonas verdes fijas donde las torres se construir√°n autom√°ticamente
        const BUILD_ZONES = [
            // Fila superior (sobre el camino)
            {x: 80, y: 60, occupied: false, tower: null},
            {x: 160, y: 60, occupied: false, tower: null},
            {x: 240, y: 60, occupied: false, tower: null},
            {x: 320, y: 60, occupied: false, tower: null},
            
            // Fila media superior
            {x: 120, y: 100, occupied: false, tower: null},
            {x: 200, y: 100, occupied: false, tower: null},
            {x: 280, y: 100, occupied: false, tower: null},
            
            // Fila inferior (bajo el camino)
            {x: 80, y: 360, occupied: false, tower: null},
            {x: 160, y: 360, occupied: false, tower: null},
            {x: 240, y: 360, occupied: false, tower: null},
            {x: 320, y: 360, occupied: false, tower: null},
            
            // Lado izquierdo
            {x: 40, y: 200, occupied: false, tower: null},
            {x: 40, y: 240, occupied: false, tower: null},
            {x: 40, y: 280, occupied: false, tower: null},
            
            // Lado derecho
            {x: 360, y: 200, occupied: false, tower: null},
            {x: 360, y: 240, occupied: false, tower: null},
            {x: 360, y: 280, occupied: false, tower: null}
        ];
        
        // Estad√≠sticas de torres
        const TOWER_STATS = {
            archer: { 
                name: "Arquero √âlite", 
                damage: 25, 
                range: 120, 
                fireRate: 800, 
                cost: 150,
                color: '#00ff88',
                icon: 'üèπ'
            },
            mage: { 
                name: "Mago Arcano", 
                damage: 40, 
                range: 150, 
                fireRate: 1200, 
                cost: 300,
                color: '#ff00ff',
                icon: 'üîÆ'
            },
            cannon: { 
                name: "Ca√±√≥n Pesado", 
                damage: 65, 
                range: 100, 
                fireRate: 1500, 
                cost: 400,
                color: '#ff8800',
                icon: 'üí£'
            },
            ice: { 
                name: "Torre Glacial", 
                damage: 15, 
                range: 110, 
                fireRate: 1000, 
                cost: 250,
                color: '#00ffff',
                icon: '‚ùÑÔ∏è',
                slow: 0.7
            }
        };
        
        // Referencias a elementos del DOM
        const goldEl = document.getElementById('gold');
        const waveEl = document.getElementById('wave');
        const livesEl = document.getElementById('lives');
        const pointsEl = document.getElementById('points');
        const gemsEl = document.getElementById('gems');
        const enemyCountEl = document.getElementById('enemyCount');
        const nextWaveTimerEl = document.getElementById('nextWaveTimer');
        const waveProgressEl = document.getElementById('waveProgress');
        const waveStatusEl = document.getElementById('waveStatus');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameOverScreen = document.getElementById('gameOver');
        const statusMessageEl = document.getElementById('statusMessage');
        
        // ============================================
        // FUNCIONES PRINCIPALES - CORREGIDAS
        // ============================================
        
        // Mostrar mensaje temporal
        function showMessage(text, type = "info") {
            statusMessageEl.textContent = text;
            
            const colors = {
                info: "#00d4ff",
                success: "#00ff00",
                warning: "#ffaa00",
                error: "#ff4444"
            };
            
            statusMessageEl.style.borderColor = colors[type] || colors.info;
            statusMessageEl.style.display = "block";
            
            setTimeout(() => {
                statusMessageEl.style.display = "none";
            }, 3000);
        }
        
        // Buscar la zona de construcci√≥n m√°s cercana a un clic
        function findNearestBuildZone(clickX, clickY) {
            let nearestZone = null;
            let minDistance = Infinity;
            
            for (const zone of BUILD_ZONES) {
                // Calcular el centro de la zona
                const zoneCenterX = zone.x + 20; // +20 porque cada zona es de 40x40
                const zoneCenterY = zone.y + 20;
                
                // Calcular distancia
                const distance = Math.sqrt(
                    Math.pow(clickX - zoneCenterX, 2) + 
                    Math.pow(clickY - zoneCenterY, 2)
                );
                
                // Si est√° lo suficientemente cerca (dentro de 30px)
                if (distance < 30 && distance < minDistance) {
                    minDistance = distance;
                    nearestZone = zone;
                }
            }
            
            return nearestZone;
        }
        
        // Construir torre en una zona espec√≠fica
        function buildTowerInZone(towerType, zone) {
            const stats = TOWER_STATS[towerType];
            
            // Verificar oro
            if (gold < stats.cost) {
                showMessage(`No tienes suficiente oro. Necesitas ${stats.cost} oro`, "error");
                return false;
            }
            
            // Verificar si la zona est√° ocupada
            if (zone.occupied) {
                showMessage("¬°Esta zona ya tiene una torre!", "error");
                return false;
            }
            
            // Construir torre
            gold -= stats.cost;
            
            const tower = {
                type: towerType,
                x: zone.x + 20, // Centro de la zona
                y: zone.y + 20,
                damage: stats.damage,
                range: stats.range,
                fireRate: stats.fireRate,
                lastShot: 0,
                level: 1,
                color: stats.color,
                icon: stats.icon,
                cost: stats.cost,
                slow: stats.slow || 1,
                zoneIndex: BUILD_ZONES.indexOf(zone)
            };
            
            towers.push(tower);
            zone.occupied = true;
            zone.tower = tower;
            
            updateUI();
            showMessage(`¬°${stats.name} construida por ${stats.cost} oro!`, "success");
            
            return true;
        }
        
        // Dibujar el camino
        function drawPath() {
            // Camino principal - m√°s visible
            ctx.fillStyle = '#8B4513'; // Marr√≥n oscuro
            ctx.fillRect(0, 120, 360, 40);   // Horizontal superior
            ctx.fillRect(360, 120, 40, 320); // Vertical derecha
            ctx.fillRect(40, 440, 320, 40);  // Horizontal inferior
            
            // Bordes del camino
            ctx.strokeStyle = '#654321'; // Marr√≥n m√°s oscuro para bordes
            ctx.lineWidth = 3;
            ctx.strokeRect(0, 120, 360, 40);
            ctx.strokeRect(360, 120, 40, 320);
            ctx.strokeRect(40, 440, 320, 40);
            
            // Marcas en el camino (para hacerlo m√°s visible)
            ctx.strokeStyle = '#DEB887'; // Marr√≥n claro
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 10]);
            
            ctx.beginPath();
            // L√≠nea central del camino superior
            ctx.moveTo(0, 140);
            ctx.lineTo(360, 140);
            // L√≠nea central del camino vertical
            ctx.moveTo(380, 120);
            ctx.lineTo(380, 440);
            // L√≠nea central del camino inferior
            ctx.moveTo(40, 460);
            ctx.lineTo(360, 460);
            ctx.stroke();
            
            ctx.setLineDash([]);
        }
        
        // Dibujar zonas de construcci√≥n
        function drawBuildZones() {
            BUILD_ZONES.forEach(zone => {
                // Color diferente si est√° ocupada
                if (zone.occupied) {
                    ctx.fillStyle = 'rgba(255, 0, 0, 0.2)'; // Rojo si ocupada
                } else {
                    ctx.fillStyle = 'rgba(0, 255, 0, 0.3)'; // Verde si disponible
                }
                
                ctx.fillRect(zone.x, zone.y, 40, 40);
                
                // Borde
                ctx.strokeStyle = zone.occupied ? 'rgba(255, 0, 0, 0.6)' : 'rgba(0, 255, 0, 0.6)';
                ctx.lineWidth = 2;
                ctx.strokeRect(zone.x, zone.y, 40, 40);
                
                // Peque√±a marca en el centro
                ctx.fillStyle = zone.occupied ? 'rgba(255, 255, 255, 0.5)' : 'rgba(255, 255, 255, 0.3)';
                ctx.fillRect(zone.x + 18, zone.y + 18, 4, 4);
            });
        }
        
        // Dibujar torres
        function drawTowers() {
            towers.forEach(tower => {
                // Base de la torre (c√≠rculo)
                ctx.fillStyle = tower.color;
                ctx.beginPath();
                ctx.arc(tower.x, tower.y, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // Borde de la torre
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Detalle interior
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.beginPath();
                ctx.arc(tower.x, tower.y, 15, 0, Math.PI * 2);
                ctx.fill();
                
                // Icono de la torre
                ctx.font = '18px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(tower.icon, tower.x, tower.y);
                
                // Nivel de la torre
                ctx.fillStyle = 'white';
                ctx.font = 'bold 12px Arial';
                ctx.fillText(`Lv${tower.level}`, tower.x, tower.y + 30);
                
                // Mostrar rango cuando se selecciona (opcional)
                if (selectedTower === tower.type) {
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.arc(tower.x, tower.y, tower.range, 0, Math.PI * 2);
                    ctx.stroke();
                }
            });
        }
        
        // Crear enemigo
        function createEnemy() {
            const baseHealth = 50 + (wave - 1) * 20;
            const baseSpeed = 1 + wave * 0.1;
            const baseBounty = 10 + wave * 5;
            
            let type = 'normal';
            let color = '#ff4444'; // Rojo
            let size = 20;
            
            if (wave >= 5) {
                type = 'elite';
                color = '#aa44ff'; // P√∫rpura
                size = 25;
            }
            
            if (wave >= 8) {
                type = 'boss';
                color = '#ff8800'; // Naranja
                size = 30;
            }
            
            const enemy = {
                x: -30,
                y: 140,
                width: size,
                height: size,
                health: type === 'elite' ? baseHealth * 1.5 : type === 'boss' ? baseHealth * 3 : baseHealth,
                maxHealth: type === 'elite' ? baseHealth * 1.5 : type === 'boss' ? baseHealth * 3 : baseHealth,
                speed: type === 'boss' ? baseSpeed * 0.7 : baseSpeed,
                bounty: type === 'elite' ? baseBounty * 2 : type === 'boss' ? baseBounty * 5 : baseBounty,
                type: type,
                color: color,
                pathIndex: 0,
                path: [
                    {x: 0, y: 140},   // Inicio
                    {x: 350, y: 140}, // Derecha
                    {x: 350, y: 430}, // Abajo
                    {x: 50, y: 430},  // Izquierda
                    {x: 50, y: 470}   // Fin (fuera del mapa)
                ]
            };
            
            enemies.push(enemy);
            return enemy;
        }
        
        // Dibujar enemigos
        function drawEnemies() {
            enemies.forEach(enemy => {
                // Cuerpo del enemigo
                ctx.fillStyle = enemy.color;
                ctx.beginPath();
                ctx.arc(enemy.x, enemy.y, enemy.width/2, 0, Math.PI * 2);
                ctx.fill();
                
                // Borde
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Ojos (para hacerlo m√°s visible)
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(enemy.x - 5, enemy.y - 3, 3, 0, Math.PI * 2);
                ctx.arc(enemy.x + 5, enemy.y - 3, 3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(enemy.x - 5, enemy.y - 3, 1.5, 0, Math.PI * 2);
                ctx.arc(enemy.x + 5, enemy.y - 3, 1.5, 0, Math.PI * 2);
                ctx.fill();
                
                // Barra de vida
                const healthPercent = enemy.health / enemy.maxHealth;
                const barWidth = 30;
                const barHeight = 5;
                const barX = enemy.x - barWidth/2;
                const barY = enemy.y - enemy.width/2 - 10;
                
                // Fondo de la barra (vida perdida)
                ctx.fillStyle = '#ff0000';
                ctx.fillRect(barX, barY, barWidth, barHeight);
                
                // Vida actual
                ctx.fillStyle = '#00ff00';
                ctx.fillRect(barX, barY, barWidth * healthPercent, barHeight);
                
                // Borde de la barra
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 1;
                ctx.strokeRect(barX, barY, barWidth, barHeight);
            });
        }
        
        // Dibujar balas
        function drawBullets() {
            bullets.forEach(bullet => {
                // Cuerpo de la bala
                ctx.fillStyle = bullet.color;
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // Destello
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(bullet.x - 2, bullet.y - 2, 2, 0, Math.PI * 2);
                ctx.fill();
                
                // Para balas de hielo, agregar efecto de fr√≠o
                if (bullet.type === 'ice') {
                    ctx.strokeStyle = 'rgba(0, 255, 255, 0.3)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.arc(bullet.x, bullet.y, 8, 0, Math.PI * 2);
                    ctx.stroke();
                }
            });
        }
        
        // Actualizar torres (disparar)
        function updateTowers(currentTime) {
            towers.forEach(tower => {
                // Buscar enemigo m√°s cercano en rango
                let target = null;
                let closestDistance = tower.range;
                
                enemies.forEach(enemy => {
                    const dx = tower.x - enemy.x;
                    const dy = tower.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < closestDistance) {
                        closestDistance = distance;
                        target = enemy;
                    }
                });
                
                // Disparar si hay un objetivo y ha pasado el tiempo de recarga
                if (target && currentTime - tower.lastShot > tower.fireRate) {
                    let damage = tower.damage;
                    if (damageBoostActive) damage *= 2;
                    
                    bullets.push({
                        x: tower.x,
                        y: tower.y,
                        target: target,
                        damage: damage,
                        color: tower.color,
                        type: tower.type,
                        slow: tower.slow
                    });
                    
                    tower.lastShot = currentTime;
                }
            });
        }
        
        // Actualizar elementos del juego
        function updateGameElements() {
            // Mover enemigos por el camino
            enemies.forEach((enemy, index) => {
                if (enemy.pathIndex < enemy.path.length - 1) {
                    const target = enemy.path[enemy.pathIndex + 1];
                    const dx = target.x - enemy.x;
                    const dy = target.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < enemy.speed) {
                        enemy.pathIndex++;
                        enemy.x = target.x;
                        enemy.y = target.y;
                    } else {
                        enemy.x += (dx / distance) * enemy.speed;
                        enemy.y += (dy / distance) * enemy.speed;
                    }
                } else {
                    // Enemigo lleg√≥ al final
                    lives--;
                    enemies.splice(index, 1);
                    
                    if (lives <= 0) {
                        gameOver();
                    }
                    
                    updateUI();
                }
            });
            
            // Mover balas y verificar impactos
            bullets.forEach((bullet, index) => {
                if (!bullet.target || bullet.target.health <= 0) {
                    bullets.splice(index, 1);
                    return;
                }
                
                const dx = bullet.target.x - bullet.x;
                const dy = bullet.target.y - bullet.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 10) {
                    // Impacto
                    bullet.target.health -= bullet.damage;
                    
                    // Efecto de ralentizaci√≥n para torre de hielo
                    if (bullet.type === 'ice') {
                        bullet.target.speed *= bullet.slow;
                    }
                    
                    // Verificar si el enemigo muri√≥
                    if (bullet.target.health <= 0) {
                        gold += bullet.target.bounty;
                        points += bullet.target.type === 'elite' ? 25 : bullet.target.type === 'boss' ? 50 : 10;
                        enemyKills++;
                        
                        const enemyIndex = enemies.indexOf(bullet.target);
                        if (enemyIndex !== -1) {
                            enemies.splice(enemyIndex, 1);
                        }
                    }
                    
                    bullets.splice(index, 1);
                } else {
                    // Mover bala hacia el objetivo
                    bullet.x += (dx / distance) * 8;
                    bullet.y += (dy / distance) * 8;
                }
            });
        }
        
        // Dibujar todo el juego
        function drawGame() {
            // Limpiar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Dibujar elementos en orden
            drawBuildZones();  // Zonas verdes primero
            drawPath();        // Camino despu√©s
            drawTowers();      // Torres
            drawEnemies();     // Enemigos
            drawBullets();     // Balas
            
            // Dibujar boost de da√±o activo
            if (damageBoostActive) {
                const timeLeft = Math.ceil((damageBoostEndTime - Date.now()) / 1000);
                if (timeLeft > 0) {
                    ctx.fillStyle = 'rgba(255, 215, 0, 0.7)';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`‚ö° x2 DA√ëO (${timeLeft}s)`, canvas.width / 2, 30);
                } else {
                    damageBoostActive = false;
                }
            }
        }
        
        // Actualizar interfaz de usuario
        function updateUI() {
            goldEl.textContent = gold;
            waveEl.textContent = wave;
            livesEl.textContent = lives;
            pointsEl.textContent = points;
            gemsEl.textContent = gems;
            enemyCountEl.textContent = enemies.length;
            
            // Actualizar barra de progreso de oleada
            const progress = ((wave - 1) / maxWaves) * 100;
            waveProgressEl.style.width = `${progress}%`;
            
            // Actualizar temporizador de siguiente oleada
            if (waveTimer > 0) {
                nextWaveTimerEl.textContent = Math.ceil(waveTimer);
            } else {
                nextWaveTimerEl.textContent = '--';
            }
            
            // Verificar si el boost de da√±o ha terminado
            if (damageBoostActive && Date.now() > damageBoostEndTime) {
                damageBoostActive = false;
                showMessage('El boost de da√±o ha terminado', "info");
            }
        }
        
        // Iniciar una oleada
        function startWave() {
            if (gameRunning) {
                showMessage("¬°Ya hay una oleada en progreso!", "error");
                return;
            }
            
            if (enemies.length > 0) {
                showMessage("¬°Termina los enemigos actuales primero!", "error");
                return;
            }
            
            gameRunning = true;
            waveStatusEl.textContent = `¬°Oleada ${wave} iniciada!`;
            waveStatusEl.style.color = "#ff6b00";
            
            // Calcular n√∫mero de enemigos para esta oleada
            const enemyCount = 5 + wave * 2;
            
            // Crear enemigos con intervalos
            for (let i = 0; i < enemyCount; i++) {
                setTimeout(() => {
                    createEnemy();
                }, i * 800); // Un enemigo cada 800ms
            }
            
            showMessage(`¬°Oleada ${wave} iniciada! ${enemyCount} enemigos se acercan`, "warning");
        }
        
        // Verificar si la oleada ha terminado
        function checkWaveEnd() {
            if (gameRunning && enemies.length === 0) {
                // Esperar un poco para asegurar que no hay m√°s enemigos spawnenados
                setTimeout(() => {
                    if (gameRunning && enemies.length === 0) {
                        endWave();
                    }
                }, 1000);
            }
        }
        
        // Finalizar oleada actual
        function endWave() {
            gameRunning = false;
            
            // Recompensas por completar la oleada
            const waveReward = wave * 100;
            points += waveReward;
            gold += wave * 50;
            gems += 2;
            
            // Verificar si el jugador gan√≥
            if (wave >= maxWaves) {
                victory();
                return;
            }
            
            // Preparar siguiente oleada
            wave++;
            waveTimer = 15; // 15 segundos para prepararse
            
            showMessage(`¬°Oleada completada! Recompensa: +${waveReward} puntos, +${wave * 50} oro, +2 gemas`, "success");
            waveStatusEl.textContent = `¬°Oleada completada! Siguiente oleada en ${waveTimer} segundos`;
            waveStatusEl.style.color = "#00ff00";
            
            updateUI();
        }
        
        // Mejorar todas las torres
        function upgradeAllTowers() {
            if (gold < 200) {
                showMessage("No tienes suficiente oro. Necesitas 200 oro", "error");
                return;
            }
            
            if (towers.length === 0) {
                showMessage("No tienes torres para mejorar", "error");
                return;
            }
            
            gold -= 200;
            
            towers.forEach(tower => {
                tower.damage *= 1.5;
                tower.range *= 1.1;
                tower.fireRate *= 0.9; // Dispara m√°s r√°pido (menos tiempo entre disparos)
                tower.level++;
            });
            
            updateUI();
            showMessage("¬°Todas las torres mejoradas! +50% da√±o, +10% alcance, +10% velocidad de ataque", "success");
        }
        
        // Vender la √∫ltima torre construida
        function sellLastTower() {
            if (towers.length === 0) {
                showMessage("No tienes torres para vender", "error");
                return;
            }
            
            const lastTower = towers.pop();
            const refund = Math.floor(lastTower.cost * 0.75);
            gold += refund;
            
            // Liberar la zona de construcci√≥n
            if (lastTower.zoneIndex !== undefined) {
                BUILD_ZONES[lastTower.zoneIndex].occupied = false;
                BUILD_ZONES[lastTower.zoneIndex].tower = null;
            }
            
            updateUI();
            showMessage(`Torre vendida por ${refund} oro (75% del costo)`, "info");
        }
        
        // Usar poder especial
        function useSpecialPower() {
            if (gems < 10) {
                showMessage("No tienes suficientes gemas. Necesitas 10 gemas", "error");
                return;
            }
            
            gems -= 10;
            
            // Eliminar todos los enemigos actuales
            let totalBounty = 0;
            enemies.forEach(enemy => {
                totalBounty += enemy.bounty;
                enemyKills++;
            });
            
            gold += totalBounty;
            enemies = [];
            
            updateUI();
            showMessage(`¬°Poder especial activado! +${totalBounty} oro`, "success");
        }
        
        // Comprar √≠tem de la tienda
        function buyItem(type, amount, cost) {
            if (gems < cost) {
                showMessage(`No tienes suficientes gemas. Necesitas ${cost} gemas`, "error");
                return;
            }
            
            gems -= cost;
            
            switch(type) {
                case 'gold':
                    gold += amount;
                    showMessage(`+${amount} oro comprado`, "success");
                    break;
                    
                case 'lives':
                    lives += amount;
                    showMessage(`+${amount} vidas compradas`, "success");
                    break;
                    
                case 'damage':
                    damageBoostActive = true;
                    damageBoostEndTime = Date.now() + 30000; // 30 segundos
                    showMessage("¬°Boost de x2 da√±o activado por 30 segundos!", "success");
                    break;
            }
            
            updateUI();
        }
        
        // Victoria
        function victory() {
            gameRunning = false;
            
            document.getElementById('gameOverTitle').textContent = 'üèÜ ¬°VICTORIA!';
            document.getElementById('victoryIcon').textContent = 'üëë';
            document.getElementById('gameOverMessage').textContent = `¬°Has completado todas las ${maxWaves} oleadas!`;
            document.getElementById('finalScore').textContent = `${points} Puntos`;
            document.getElementById('finalWaves').textContent = wave;
            document.getElementById('finalTowers').textContent = towers.length;
            document.getElementById('finalEnemies').textContent = enemyKills;
            
            gameOverScreen.style.display = 'flex';
        }
        
        // Game Over
        function gameOver() {
            gameRunning = false;
            
            document.getElementById('gameOverTitle').textContent = 'üíÄ GAME OVER';
            document.getElementById('victoryIcon').textContent = 'üò¢';
            document.getElementById('gameOverMessage').textContent = 'Los enemigos han invadido tu reino';
            document.getElementById('finalScore').textContent = `${points} Puntos`;
            document.getElementById('finalWaves').textContent = wave;
            document.getElementById('finalTowers').textContent = towers.length;
            document.getElementById('finalEnemies').textContent = enemyKills;
            
            gameOverScreen.style.display = 'flex';
        }
        
        // Reiniciar juego
        function resetGame() {
            gold = 1000;
            wave = 1;
            lives = 30;
            points = 0;
            gems = 50;
            towers = [];
            enemies = [];
            bullets = [];
            enemyKills = 0;
            gameRunning = false;
            selectedTower = null;
            damageBoostActive = false;
            waveTimer = 0;
            
            // Liberar todas las zonas de construcci√≥n
            BUILD_ZONES.forEach(zone => {
                zone.occupied = false;
                zone.tower = null;
            });
            
            gameOverScreen.style.display = 'none';
            updateUI();
            showMessage("¬°Juego reiniciado! Selecciona una torre y haz clic en una zona verde para construir", "info");
        }
        
        // Continuar juego (modo extendido)
        function continueGame() {
            maxWaves = 20;
            gameOverScreen.style.display = 'none';
            showMessage("¬°Modo extendido activado! Sobrevive hasta la oleada 20", "success");
        }
        
        // Compartir puntaje
        function shareScore() {
            const text = `¬°Consegu√≠ ${points} puntos en Kingdom Defense Pro! ¬øPuedes superarme?`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Kingdom Defense Pro',
                    text: text
                });
            } else {
                navigator.clipboard.writeText(text);
                showMessage("¬°Puntaje copiado al portapapeles!", "success");
            }
        }
        
        // ============================================
        // INICIALIZACI√ìN Y BUCLE DEL JUEGO
        // ============================================
        
        // Inicializar juego
        function initGame() {
            console.log("Inicializando juego...");
            
            // Configurar eventos de selecci√≥n de torres
            document.querySelectorAll('.tower-card').forEach(card => {
                card.addEventListener('click', function() {
                    // Remover selecci√≥n anterior
                    document.querySelectorAll('.tower-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    
                    // Agregar selecci√≥n actual
                    this.classList.add('selected');
                    selectedTower = this.dataset.tower;
                    
                    const stats = TOWER_STATS[selectedTower];
                    showMessage(`${stats.name} seleccionada (${stats.cost} oro) - Haz clic en una zona verde`, "info");
                });
            });
            
            // Configurar botones de control
            document.getElementById('startWave').addEventListener('click', startWave);
            document.getElementById('upgradeAll').addEventListener('click', upgradeAllTowers);
            document.getElementById('sellTower').addEventListener('click', sellLastTower);
            document.getElementById('specialPower').addEventListener('click', useSpecialPower);
            
            // Configurar tienda
            document.getElementById('buyGold').addEventListener('click', () => buyItem('gold', 500, 5));
            document.getElementById('buyLives').addEventListener('click', () => buyItem('lives', 10, 8));
            document.getElementById('buyDamage').addEventListener('click', () => buyItem('damage', 0, 15));
            
            // Configurar pantalla de game over
            document.getElementById('playAgain').addEventListener('click', resetGame);
            document.getElementById('continueGame').addEventListener('click', continueGame);
            document.getElementById('shareScore').addEventListener('click', shareScore);
            
            // Configurar evento de clic en el canvas PARA CONSTRUIR TORRES
            canvas.addEventListener('click', (e) => {
                if (!selectedTower) {
                    showMessage("Primero selecciona una torre del panel derecho", "error");
                    return;
                }
                
                const rect = canvas.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;
                
                // Buscar la zona de construcci√≥n m√°s cercana
                const nearestZone = findNearestBuildZone(clickX, clickY);
                
                if (nearestZone) {
                    // Construir torre en esta zona
                    buildTowerInZone(selectedTower, nearestZone);
                } else {
                    showMessage("Haz clic en una zona verde para construir", "error");
                }
            });
            
            // Actualizar interfaz inicial
            updateUI();
            
            // Iniciar bucle del juego
            requestAnimationFrame(gameLoop);
            
            showMessage("¬°Juego listo! Selecciona una torre y haz clic en una zona verde", "info");
        }
        
        // Bucle principal del juego
        let lastTime = 0;
        function gameLoop(currentTime) {
            // Calcular delta time
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;
            
            // Actualizar torres (disparar)
            updateTowers(currentTime);
            
            // Actualizar elementos del juego
            updateGameElements();
            
            // Dibujar todo
            drawGame();
            
            // Verificar si la oleada termin√≥
            checkWaveEnd();
            
            // Actualizar temporizador entre oleadas
            if (waveTimer > 0 && !gameRunning) {
                waveTimer -= deltaTime / 1000;
                if (waveTimer <= 0) {
                    waveTimer = 0;
                    waveStatusEl.textContent = "¬°Preparado para la siguiente oleada!";
                }
                nextWaveTimerEl.textContent = Math.ceil(waveTimer);
                updateUI();
            }
            
            // Continuar el bucle
            requestAnimationFrame(gameLoop);
        }
        
        // Iniciar el juego cuando el documento est√© listo
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>