<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kingdom Defense Pro - Juego de Estrategia Mejorado</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a192f, #1a365d);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        
        h1 {
            color: #00d4ff;
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.7);
        }
        
        .game-area {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .game-board {
            flex: 3;
            min-width: 300px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #00d4ff;
            position: relative;
        }
        
        .game-info {
            flex: 1;
            min-width: 250px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #ff6b00;
        }
        
        #gameCanvas {
            width: 100%;
            height: 600px;
            background: #0f3460;
            border-radius: 10px;
            border: 2px solid #00d4ff;
            display: block;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
        }
        
        .grid-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            pointer-events: none;
        }
        
        .grid-cell {
            position: absolute;
            border: 1px dashed rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .buildable {
            background: rgba(0, 255, 0, 0.3) !important;
            border: 2px solid rgba(0, 255, 0, 0.6) !important;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .buildable:hover {
            background: rgba(0, 255, 0, 0.5) !important;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }
        
        .path-cell {
            background: rgba(139, 69, 19, 0.5) !important;
            border: 2px solid rgba(160, 82, 45, 0.8) !important;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: rgba(255, 107, 0, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 0, 0.3);
        }
        
        .stat-item {
            text-align: center;
            padding: 0 10px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #ff6b00;
            text-shadow: 0 0 10px rgba(255, 107, 0, 0.5);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            background: linear-gradient(45deg, #00d4ff, #0099ff);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 150px;
            justify-content: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-premium {
            background: linear-gradient(45deg, #ff6b00, #ff3d00);
        }
        
        .btn-premium:hover {
            box-shadow: 0 5px 15px rgba(255, 107, 0, 0.4);
        }
        
        .towers {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .tower-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .tower-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }
        
        .tower-card.selected {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }
        
        .tower-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
        }
        
        .tower-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #00d4ff;
        }
        
        .tower-cost {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.2rem;
            margin: 5px 0;
        }
        
        .tower-stats {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 5px;
        }
        
        .shop {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            border: 2px solid #9d4edd;
        }
        
        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .shop-item {
            background: rgba(157, 78, 221, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .shop-item:hover {
            background: rgba(157, 78, 221, 0.3);
            transform: translateY(-2px);
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #00d4ff;
        }
        
        .enemy-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 0, 0, 0.1);
            border-radius: 5px;
        }
        
        .enemy-icon {
            font-size: 1.5rem;
        }
        
        .wave-info {
            background: rgba(0, 212, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .wave-progress {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .wave-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #0099ff);
            width: 0%;
            transition: width 0.3s;
        }
        
        .game-over {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .game-over-content {
            background: linear-gradient(135deg, #0f3460, #1a365d);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 3px solid #00d4ff;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
        }
        
        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
            }
            
            .towers {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè∞ KINGDOM DEFENSE PRO</h1>
            <p>Juego de Estrategia Mejorado - Defiende tu reino con t√°ctica</p>
        </header>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-label">üí∞ ORO</div>
                <div class="stat-value" id="gold">1000</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">‚öîÔ∏è OLEADA</div>
                <div class="stat-value" id="wave">1</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">‚ù§Ô∏è VIDAS</div>
                <div class="stat-value" id="lives">30</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">üéØ PUNTOS</div>
                <div class="stat-value" id="points">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">üíé GEMAS</div>
                <div class="stat-value" id="gems">50</div>
            </div>
        </div>
        
        <div class="game-area">
            <div class="game-board">
                <canvas id="gameCanvas" width="800" height="600"></canvas>
                <div class="grid-overlay" id="gridOverlay"></div>
                
                <div class="controls">
                    <button class="btn" id="startWave">
                        <span>‚ñ∂Ô∏è</span> Iniciar Oleada (1-10)
                    </button>
                    <button class="btn" id="upgradeAll">
                        <span>‚ö°</span> Mejorar Todas (200 oro)
                    </button>
                    <button class="btn" id="sellTower">
                        <span>üí∞</span> Vender Torre (75%)
                    </button>
                    <button class="btn btn-premium" id="specialPower">
                        <span>‚ú®</span> Poder Especial (10 gemas)
                    </button>
                </div>
                
                <div class="wave-info">
                    <h3>üìä Progreso de Oleada</h3>
                    <div class="wave-progress">
                        <div class="wave-progress-bar" id="waveProgress"></div>
                    </div>
                    <p id="waveStatus">Preparando defensas...</p>
                </div>
            </div>
            
            <div class="game-info">
                <h2 style="color: #00d4ff; margin-bottom: 15px;">üèóÔ∏è CONSTRUIR TORRES</h2>
                <p style="color: #aaa; margin-bottom: 15px;">Selecciona una torre y haz clic en una casilla verde para construir</p>
                
                <div class="towers">
                    <div class="tower-card" data-tower="archer" data-cost="150">
                        <div class="tower-icon">üèπ</div>
                        <div class="tower-name">Arquero √âlite</div>
                        <div class="tower-cost">150 ü™ô</div>
                        <div class="tower-stats">üéØ Da√±o: 25 ‚ö° Vel: R√°pida</div>
                    </div>
                    
                    <div class="tower-card" data-tower="mage" data-cost="300">
                        <div class="tower-icon">üîÆ</div>
                        <div class="tower-name">Mago Arcano</div>
                        <div class="tower-cost">300 ü™ô</div>
                        <div class="tower-stats">üéØ Da√±o: 40 ‚ö° Vel: Media</div>
                    </div>
                    
                    <div class="tower-card" data-tower="cannon" data-cost="400">
                        <div class="tower-icon">üí£</div>
                        <div class="tower-name">Ca√±√≥n Pesado</div>
                        <div class="tower-cost">400 ü™ô</div>
                        <div class="tower-stats">üéØ Da√±o: 65 ‚ö° Vel: Lenta</div>
                    </div>
                    
                    <div class="tower-card" data-tower="ice" data-cost="250">
                        <div class="tower-icon">‚ùÑÔ∏è</div>
                        <div class="tower-name">Torre Glacial</div>
                        <div class="tower-cost">250 ü™ô</div>
                        <div class="tower-stats">üéØ Da√±o: 15 ‚ö° Ralentiza</div>
                    </div>
                </div>
                
                <div class="instructions">
                    <h3 style="color: #ff6b00; margin-bottom: 10px;">üéÆ C√ìMO JUGAR</h3>
                    <ul style="list-style: none; padding-left: 0;">
                        <li style="margin-bottom: 8px;">‚úÖ <strong>Casillas verdes</strong> = Zonas para construir</li>
                        <li style="margin-bottom: 8px;">‚úÖ Cada torre tiene <strong>estad√≠sticas √∫nicas</strong></li>
                        <li style="margin-bottom: 8px;">‚úÖ Los enemigos siguen el <strong>camino marr√≥n</strong></li>
                        <li style="margin-bottom: 8px;">‚úÖ <strong>Mejora torres</strong> para m√°s da√±o</li>
                        <li style="margin-bottom: 8px;">‚úÖ Sobrevive a <strong>10 oleadas</strong> para ganar</li>
                    </ul>
                </div>
                
                <div class="enemy-info">
                    <div class="enemy-icon">üëπ</div>
                    <div>
                        <div><strong>Enemigos Activos:</strong> <span id="enemyCount">0</span></div>
                        <div><strong>Siguiente oleada en:</strong> <span id="nextWaveTimer">--</span>s</div>
                    </div>
                </div>
                
                <div class="shop">
                    <h2 style="color: #9d4edd; margin-bottom: 15px;">üõí TIENDA PREMIUM</h2>
                    
                    <div class="shop-items">
                        <div class="shop-item" id="buyGold">
                            <div style="font-size: 1.8rem; color: #ffd700;">ü™ô</div>
                            <div>+500 Oro</div>
                            <div style="margin: 8px 0; color: #9d4edd;">5 üíé</div>
                        </div>
                        
                        <div class="shop-item" id="buyLives">
                            <div style="font-size: 1.8rem; color: #ff4444;">‚ù§Ô∏è</div>
                            <div>+10 Vidas</div>
                            <div style="margin: 8px 0; color: #9d4edd;">8 üíé</div>
                        </div>
                        
                        <div class="shop-item" id="buyDamage">
                            <div style="font-size: 1.8rem; color: #00d4ff;">‚ö°</div>
                            <div>x2 Da√±o 30s</div>
                            <div style="margin: 8px 0; color: #9d4edd;">15 üíé</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.4); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
            <p>üéÆ <strong>Juego de estrategia mejorado</strong> - Balance perfecto - Gr√°ficos optimizados</p>
            <p style="font-size: 0.9rem; margin-top: 10px; color: #aaa;">Las compras son opcionales. Juego 100% legal sin apuestas.</p>
        </div>
    </div>
    
    <!-- Pantalla de Game Over -->
    <div class="game-over" id="gameOver">
        <div class="game-over-content">
            <h2 id="gameOverTitle" style="color: #00d4ff; margin-bottom: 20px;">üèÜ ¬°VICTORIA!</h2>
            <div id="victoryIcon" style="font-size: 5rem; margin: 20px 0;">üëë</div>
            <p id="gameOverMessage" style="margin-bottom: 20px;">Has completado todas las oleadas</p>
            
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
                <div style="font-size: 2.5rem; color: #ffd700; margin: 10px 0;" id="finalScore">0 Puntos</div>
                <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                    <div>
                        <div style="color: #aaa;">Oleadas</div>
                        <div style="color: #00d4ff; font-size: 1.5rem;" id="finalWaves">0</div>
                    </div>
                    <div>
                        <div style="color: #aaa">Torres</div>
                        <div style="color: #00d4ff; font-size: 1.5rem;" id="finalTowers">0</div>
                    </div>
                    <div>
                        <div style="color: #aaa">Enemigos</div>
                        <div style="color: #00d4ff; font-size: 1.5rem;" id="finalEnemies">0</div>
                    </div>
                </div>
            </div>
            
            <div style="margin: 30px 0;">
                <button class="btn" id="playAgain" style="margin: 5px;">
                    <span>üîÑ</span> Jugar Otra Vez
                </button>
                <button class="btn btn-premium" id="continueGame" style="margin: 5px;">
                    <span>üöÄ</span> Continuar (Oleadas 11-20)
                </button>
            </div>
            
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px;">
                <p>¬øQuieres registrar tu r√©cord?</p>
                <button class="btn" id="shareScore" style="width: 100%; margin-top: 10px;">
                    <span>üì§</span> Compartir Puntaje
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN MEJORADA DEL JUEGO
        // ============================================
        
        // Variables del juego
        let gold = 1000;
        let wave = 1;
        let lives = 30;
        let points = 0;
        let gems = 50;
        let gameRunning = false;
        let selectedTower = null;
        let towers = [];
        let enemies = [];
        let bullets = [];
        let enemyKills = 0;
        let maxWaves = 10;
        let waveTimer = 0;
        let specialPowerActive = false;
        let damageBoostActive = false;
        let damageBoostEndTime = 0;
        
        // Estad√≠sticas de torres
        const towerStats = {
            archer: { damage: 25, range: 100, fireRate: 500, cost: 150 },
            mage: { damage: 40, range: 120, fireRate: 1000, cost: 300 },
            cannon: { damage: 65, range: 80, fireRate: 1500, cost: 400 },
            ice: { damage: 15, range: 90, fireRate: 800, cost: 250, slow: true }
        };
        
        // Referencias a elementos del DOM
        const goldEl = document.getElementById('gold');
        const waveEl = document.getElementById('wave');
        const livesEl = document.getElementById('lives');
        const pointsEl = document.getElementById('points');
        const gemsEl = document.getElementById('gems');
        const enemyCountEl = document.getElementById('enemyCount');
        const nextWaveTimerEl = document.getElementById('nextWaveTimer');
        const waveProgressEl = document.getElementById('waveProgress');
        const waveStatusEl = document.getElementById('waveStatus');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gridOverlay = document.getElementById('gridOverlay');
        const gameOverScreen = document.getElementById('gameOver');
        
        // ============================================
        // FUNCIONES PRINCIPALES DEL JUEGO
        // ============================================
        
        // 1. CREAR GRID Y CAMINO M√ÅS VISIBLE
        function createGridAndPath() {
            const gridSize = 40;
            const cols = Math.floor(canvas.width / gridSize);
            const rows = Math.floor(canvas.height / gridSize);
            gridOverlay.innerHTML = '';
            
            // Definir el camino (m√°s visible)
            const pathCells = [];
            // Camino horizontal superior
            for (let x = 0; x <= 9; x++) {
                pathCells.push([x, 3]);
            }
            // Camino vertical derecho
            for (let y = 3; y <= 12; y++) {
                pathCells.push([9, y]);
            }
            // Camino horizontal inferior
            for (let x = 9; x >= 0; x--) {
                pathCells.push([x, 12]);
            }
            
            // Definir zonas de construcci√≥n (m√°s claras)
            const buildableCells = [
                [2, 5], [3, 5], [4, 5], [5, 5], [6, 5], [7, 5],
                [2, 8], [3, 8], [4, 8], [5, 8], [6, 8], [7, 8],
                [1, 6], [1, 7], [1, 9], [1, 10],
                [8, 6], [8, 7], [8, 9], [8, 10]
            ];
            
            // Crear celdas de camino
            pathCells.forEach(([x, y]) => {
                const cell = document.createElement('div');
                cell.className = 'grid-cell path-cell';
                cell.style.width = `${gridSize}px`;
                cell.style.height = `${gridSize}px`;
                cell.style.left = `${x * gridSize}px`;
                cell.style.top = `${y * gridSize}px`;
                gridOverlay.appendChild(cell);
            });
            
            // Crear zonas de construcci√≥n
            buildableCells.forEach(([x, y]) => {
                const cell = document.createElement('div');
                cell.className = 'grid-cell buildable';
                cell.style.width = `${gridSize}px`;
                cell.style.height = `${gridSize}px`;
                cell.style.left = `${x * gridSize}px`;
                cell.style.top = `${y * gridSize}px`;
                cell.addEventListener('click', () => buildTower(x, y));
                gridOverlay.appendChild(cell);
            });
        }
        
        // 2. CONSTRUIR TORRE
        function buildTower(gridX, gridY) {
            if (!selectedTower) {
                alert('Primero selecciona una torre para construir');
                return;
            }
            
            const stats = towerStats[selectedTower];
            if (gold < stats.cost) {
                alert(`No tienes suficiente oro! Necesitas ${stats.cost}`);
                return;
            }
            
            // Verificar si ya hay una torre aqu√≠
            const x = gridX * 40 + 20;
            const y = gridY * 40 + 20;
            
            const existingTower = towers.find(t => 
                Math.abs(t.x - x) < 40 && Math.abs(t.y - y) < 40
            );
            
            if (existingTower) {
                alert('Ya hay una torre aqu√≠!');
                return;
            }
            
            gold -= stats.cost;
            towers.push({
                type: selectedTower,
                x: x,
                y: y,
                damage: stats.damage,
                range: stats.range,
                fireRate: stats.fireRate,
                lastShot: 0,
                level: 1,
                color: getTowerColor(selectedTower)
            });
            
            updateUI();
            showMessage(`Torre ${selectedTower} construida por ${stats.cost} oro`);
        }
        
        // 3. INICIAR SIGUIENTE OLEADA
        function startNextWave() {
            if (gameRunning || enemies.length > 0) {
                alert('¬°Termina la oleada actual primero!');
                return;
            }
            
            wave++;
            updateUI();
            gameRunning = true;
            waveTimer = 0;
            
            // Crear enemigos basados en la oleada
            const enemyCount = 5 + wave * 2;
            
            for (let i = 0; i < enemyCount; i++) {
                setTimeout(() => {
                    createEnemy();
                }, i * 1000);
            }
            
            waveStatusEl.textContent = `Oleada ${wave} en progreso (${enemigos.length} enemigos)`;
            showMessage(`¬°Oleada ${wave} iniciada! ${enemyCount} enemigos se acercan`);
        }
        
        // 4. CREAR ENEMIGO
        function createEnemy() {
            const baseHealth = 50 + (wave - 1) * 20; // Ajustado: menos vida
            const baseSpeed = 1 + wave * 0.1;
            const baseBounty = 10 + wave * 5;
            
            const enemy = {
                x: 0,
                y: 120,
                width: 30,
                height: 30,
                health: baseHealth,
                maxHealth: baseHealth,
                speed: baseSpeed,
                bounty: baseBounty,
                pathIndex: 0,
                color: wave < 3 ? 'red' : wave < 6 ? 'purple' : 'orange'
            };
            
            enemies.push(enemy);
        }
        
        // 5. ACTUALIZAR TORRES (DISPARAR)
        function updateTowers(currentTime) {
            towers.forEach(tower => {
                // Encontrar enemigo en rango
                const target = enemies.find(enemy => {
                    const dx = tower.x - enemy.x;
                    const dy = tower.y - enemy.y;
                    return Math.sqrt(dx*dx + dy*dy) <= tower.range;
                });
                
                if (target && currentTime - tower.lastShot > tower.fireRate) {
                    // Disparar
                    bullets.push({
                        x: tower.x,
                        y: tower.y,
                        target: target,
                        damage: damageBoostActive ? tower.damage * 2 : tower.damage,
                        color: tower.color,
                        type: tower.type
                    });
                    
                    tower.lastShot = currentTime;
                }
            });
        }
        
        // 6. VERIFICAR SI OLEADA COMPLETADA
        function checkWaveComplete() {
            if (gameRunning && enemies.length === 0) {
                gameRunning = false;
                points += wave * 100;
                gold += wave * 50;
                gems += 5;
                
                if (wave >= maxWaves) {
                    showVictory();
                } else {
                    waveStatusEl.textContent = `¬°Oleada ${wave} completada! Preparando oleada ${wave + 1}`;
                    waveTimer = 10; // 10 segundos entre oleadas
                    showMessage(`¬°Oleada ${wave} completada! Recompensa: +${wave * 100} puntos, +${wave * 50} oro, +5 gemas`);
                }
                updateUI();
            }
        }
        
        // 7. ACTUALIZAR INTERFAZ
        function updateUI() {
            goldEl.textContent = gold;
            waveEl.textContent = wave;
            livesEl.textContent = lives;
            pointsEl.textContent = points;
            gemsEl.textContent = gems;
            enemyCountEl.textContent = enemies.length;
            
            // Actualizar progreso de oleada
            const progress = ((wave - 1) / maxWaves) * 100;
            waveProgressEl.style.width = `${progress}%`;
            
            // Actualizar temporizador
            if (waveTimer > 0) {
                nextWaveTimerEl.textContent = waveTimer;
            } else {
                nextWaveTimerEl.textContent = '--';
            }
            
            // Actualizar boost de da√±o
            if (damageBoostActive && Date.now() > damageBoostEndTime) {
                damageBoostActive = false;
                showMessage('El boost de da√±o ha terminado');
            }
        }
        
        // 8. DIBUJAR ELEMENTOS EN CANVAS
        function drawGameElements() {
            // Limpiar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Dibujar camino
            drawPath();
            
            // Dibujar torres
            drawTowers();
            
            // Dibujar enemigos
            drawEnemies();
            
            // Dibujar balas
            drawBullets();
            
            // Dibujar boost de da√±o activo
            if (damageBoostActive) {
                const timeLeft = Math.ceil((damageBoostEndTime - Date.now()) / 1000);
                ctx.fillStyle = 'rgba(255, 215, 0, 0.7)';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`‚ö° x2 DA√ëO (${timeLeft}s)`, canvas.width / 2, 30);
            }
        }
        
        function drawPath() {
            ctx.fillStyle = '#8B4513';
            // Camino horizontal superior
            ctx.fillRect(0, 120, 360, 40);
            // Camino vertical derecho
            ctx.fillRect(360, 120, 40, 320);
            // Camino horizontal inferior
            ctx.fillRect(40, 440, 320, 40);
            
            // Bordes del camino
            ctx.strokeStyle = '#654321';
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 120, 360, 40);
            ctx.strokeRect(360, 120, 40, 320);
            ctx.strokeRect(40, 440, 320, 40);
        }
        
        function drawTowers() {
            towers.forEach(tower => {
                // Cuerpo de la torre
                ctx.fillStyle = tower.color;
                ctx.beginPath();
                ctx.arc(tower.x, tower.y, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // Borde
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Mostrar nivel
                ctx.fillStyle = 'white';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`Lv${tower.level}`, tower.x, tower.y + 30);
            });
        }
        
        function drawEnemies() {
            enemies.forEach((enemy, index) => {
                // Dibujar enemigo
                ctx.fillStyle = enemy.color;
                ctx.beginPath();
                ctx.arc(enemy.x + 15, enemy.y + 15, 15, 0, Math.PI * 2);
                ctx.fill();
                
                // Borde del enemigo
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Barra de vida
                const healthPercent = enemy.health / enemy.maxHealth;
                ctx.fillStyle = 'red';
                ctx.fillRect(enemy.x, enemy.y - 10, 30, 5);
                ctx.fillStyle = 'lime';
                ctx.fillRect(enemy.x, enemy.y - 10, 30 * healthPercent, 5);
            });
        }
        
        function drawBullets() {
            bullets.forEach(bullet => {
                ctx.fillStyle = bullet.color;
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // Destello en balas
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(bullet.x - 2, bullet.y - 2, 2, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        // 9. MOVER ELEMENTOS DEL JUEGO
        function updateGameElements() {
            // Mover enemigos por el camino
            enemies.forEach((enemy, index) => {
                // Camino: derecha -> abajo -> izquierda
                if (enemy.x < 360) {
                    enemy.x += enemy.speed;
                } else if (enemy.y < 440) {
                    enemy.y += enemy.speed;
                } else if (enemy.x > 40) {
                    enemy.x -= enemy.speed;
                } else {
                    // Enemigo lleg√≥ al final
                    lives--;
                    enemies.splice(index, 1);
                    if (lives <= 0) {
                        showGameOver();
                    }
                    updateUI();
                    return;
                }
            });
            
            // Mover balas
            bullets.forEach((bullet, index) => {
                if (!bullet.target || bullet.target.health <= 0) {
                    bullets.splice(index, 1);
                    return;
                }
                
                const dx = bullet.target.x - bullet.x;
                const dy = bullet.target.y - bullet.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < 10) {
                    // Impacto
                    bullet.target.health -= bullet.damage;
                    
                    // Efecto de ralentizaci√≥n para torre de hielo
                    if (bullet.type === 'ice' && bullet.target.speed > 0.5) {
                        bullet.target.speed *= 0.7;
                    }
                    
                    if (bullet.target.health <= 0) {
                        gold += bullet.target.bounty;
                        points += 10;
                        enemyKills++;
                        enemies.splice(enemies.indexOf(bullet.target), 1);
                    }
                    bullets.splice(index, 1);
                } else {
                    // Mover bala hacia el objetivo
                    bullet.x += dx / dist * 8;
                    bullet.y += dy / dist * 8;
                }
            });
        }
        
        // 10. FUNCIONES AUXILIARES
        function getTowerColor(type) {
            const colors = {
                archer: '#00ff88',
                mage: '#ff00ff',
                cannon: '#ff8800',
                ice: '#00ffff'
            };
            return colors[type] || '#ffffff';
        }
        
        function showMessage(text) {
            waveStatusEl.textContent = text;
            setTimeout(() => {
                if (!gameRunning) {
                    waveStatusEl.textContent = `Preparando oleada ${wave + 1}...`;
                }
            }, 3000);
        }
        
        // 11. FUNCIONES DE FIN DE JUEGO
        function showVictory() {
            document.getElementById('gameOverTitle').textContent = 'üèÜ ¬°VICTORIA!';
            document.getElementById('victoryIcon').textContent = 'üëë';
            document.getElementById('gameOverMessage').textContent = `Has completado todas las ${maxWaves} oleadas!`;
            document.getElementById('finalScore').textContent = `${points} Puntos`;
            document.getElementById('finalWaves').textContent = wave;
            document.getElementById('finalTowers').textContent = towers.length;
            document.getElementById('finalEnemies').textContent = enemyKills;
            gameOverScreen.style.display = 'flex';
        }
        
        function showGameOver() {
            document.getElementById('gameOverTitle').textContent = 'üíÄ GAME OVER';
            document.getElementById('victoryIcon').textContent = 'üò¢';
            document.getElementById('gameOverMessage').textContent = 'Los enemigos han invadido tu reino';
            document.getElementById('finalScore').textContent = `${points} Puntos`;
            document.getElementById('finalWaves').textContent = wave;
            document.getElementById('finalTowers').textContent = towers.length;
            document.getElementById('finalEnemies').textContent = enemyKills;
            gameOverScreen.style.display = 'flex';
        }
        
        function resetGame() {
            gold = 1000;
            wave = 1;
            lives = 30;
            points = 0;
            gems = 50;
            towers = [];
            enemies = [];
            bullets = [];
            enemyKills = 0;
            gameRunning = false;
            selectedTower = null;
            damageBoostActive = false;
            waveTimer = 0;
            gameOverScreen.style.display = 'none';
            updateUI();
            createGridAndPath();
            showMessage('¬°Juego reiniciado! Construye torres y defiende tu reino');
        }
        
        // 12. BUCLE PRINCIPAL DEL JUEGO
        function gameLoop(timestamp) {
            updateTowers(timestamp);
            updateGameElements();
            drawGameElements();
            checkWaveComplete();
            
            // Actualizar temporizador entre oleadas
            if (waveTimer > 0 && !gameRunning) {
                waveTimer--;
                nextWaveTimerEl.textContent = waveTimer;
                if (waveTimer === 0) {
                    startNextWave();
                }
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // ============================================
        // INICIALIZACI√ìN Y EVENTOS
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Crear grid y camino
            createGridAndPath();
            
            // Selecci√≥n de torres
            document.querySelectorAll('.tower-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.tower-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedTower = this.dataset.tower;
                    showMessage(`Torre ${selectedTower} seleccionada. Haz clic en una zona verde para construir`);
                });
            });
            
            // Bot√≥n de iniciar oleada
            document.getElementById('startWave').addEventListener('click', startNextWave);
            
            // Bot√≥n de mejorar todas las torres
            document.getElementById('upgradeAll').addEventListener('click', function() {
                if (gold >= 200 && towers.length > 0) {
                    towers.forEach(tower => {
                        tower.damage *= 1.5;
                        tower.range *= 1.2;
                        tower.fireRate *= 0.9; // Dispara m√°s r√°pido
                        tower.level++;
                    });
                    gold -= 200;
                    updateUI();
                    showMessage('¬°Todas las torres mejoradas! +50% da√±o, +20% alcance');
                } else if (towers.length === 0) {
                    alert('¬°No tienes torres para mejorar!');
                } else {
                    alert('¬°No tienes suficiente oro! Necesitas 200 oro');
                }
            });
            
            // Bot√≥n de vender torre
            document.getElementById('sellTower').addEventListener('click', function() {
                if (selectedTower) {
                    // Buscar torre seleccionada para vender
                    const towerIndex = towers.findIndex(t => t.type === selectedTower);
                    if (towerIndex !== -1) {
                        const tower = towers[towerIndex];
                        const refund = Math.floor(towerStats[tower.type].cost * 0.75);
                        gold += refund;
                        towers.splice(towerIndex, 1);
                        updateUI();
                        showMessage(`Torre vendida por ${refund} oro (75% del costo)`);
                    } else {
                        alert('Selecciona una torre en el mapa para vender');
                    }
                } else {
                    alert('Selecciona una torre primero');
                }
            });
            
            // Bot√≥n de poder especial
            document.getElementById('specialPower').addEventListener('click', function() {
                if (gems >= 10) {
                    gems -= 10;
                    // Elimina todos los enemigos actuales
                    enemies.forEach(enemy => {
                        gold += enemy.bounty;
                        points += 10;
                        enemyKills++;
                    });
                    enemies = [];
                    updateUI();
                    showMessage('¬°Poder especial activado! Todos los enemigos eliminados');
                } else {
                    alert('¬°No tienes suficientes gemas! Necesitas 10 gemas');
                }
            });
            
            // Botones de la tienda
            document.getElementById('buyGold').addEventListener('click', function() {
                if (gems >= 5) {
                    gems -= 5;
                    gold += 500;
                    updateUI();
                    showMessage('+500 oro comprado por 5 gemas');
                } else {
                    alert('¬°No tienes suficientes gemas! Necesitas 5 gemas');
                }
            });
            
            document.getElementById('buyLives').addEventListener('click', function() {
                if (gems >= 8) {
                    gems -= 8;
                    lives += 10;
                    updateUI();
                    showMessage('+10 vidas compradas por 8 gemas');
                } else {
                    alert('¬°No tienes suficientes gemas! Necesitas 8 gemas');
                }
            });
            
            document.getElementById('buyDamage').addEventListener('click', function() {
                if (gems >= 15) {
                    gems -= 15;
                    damageBoostActive = true;
                    damageBoostEndTime = Date.now() + 30000; // 30 segundos
                    updateUI();
                    showMessage('¬°Boost de x2 da√±o activado por 30 segundos!');
                } else {
                    alert('¬°No tienes suficientes gemas! Necesitas 15 gemas');
                }
            });
            
            // Botones de game over
            document.getElementById('playAgain').addEventListener('click', resetGame);
            
            document.getElementById('continueGame').addEventListener('click', function() {
                maxWaves = 20;
                gameOverScreen.style.display = 'none';
                showMessage('¬°Modo extendido activado! Sobrevive hasta la oleada 20');
            });
            
            document.getElementById('shareScore').addEventListener('click', function() {
                const shareText = `¬°He conseguido ${points} puntos en Kingdom Defense Pro! ¬øPuedes superarme?`;
                if (navigator.share) {
                    navigator.share({
                        title: 'Kingdom Defense Pro',
                        text: shareText,
                        url: window.location.href
                    });
                } else {
                    alert('Copia este texto para compartir:\n\n' + shareText);
                }
            });
            
            // Inicializar UI
            updateUI();
            
            // Iniciar bucle del juego
            requestAnimationFrame(gameLoop);
        });
    </script>
</body>
</html>