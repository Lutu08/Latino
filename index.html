<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kingdom Defense - Juego Mejorado</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a192f, #1a365d);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        
        h1 {
            color: #00d4ff;
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.7);
        }
        
        .game-area {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .game-board {
            flex: 3;
            min-width: 300px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #00d4ff;
            position: relative;
        }
        
        .game-info {
            flex: 1;
            min-width: 250px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #ff6b00;
        }
        
        #gameCanvas {
            width: 100%;
            height: 600px;
            background: #0f3460;
            border-radius: 10px;
            border: 2px solid #00d4ff;
            display: block;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
        }
        
        .grid-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            pointer-events: none;
        }
        
        .grid-cell {
            position: absolute;
            border: 1px dashed rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .buildable {
            background: rgba(0, 255, 0, 0.1) !important;
            border-color: rgba(0, 255, 0, 0.3) !important;
        }
        
        .path-cell {
            background: rgba(139, 69, 19, 0.3) !important;
            border-color: rgba(160, 82, 45, 0.5) !important;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: rgba(255, 107, 0, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 0, 0.3);
        }
        
        .stat-item {
            text-align: center;
            padding: 0 10px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #ff6b00;
            text-shadow: 0 0 10px rgba(255, 107, 0, 0.5);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            background: linear-gradient(45deg, #00d4ff, #0099ff);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 150px;
            justify-content: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-premium {
            background: linear-gradient(45deg, #ff6b00, #ff3d00);
        }
        
        .btn-premium:hover {
            box-shadow: 0 5px 15px rgba(255, 107, 0, 0.4);
        }
        
        .towers {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .tower-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .tower-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }
        
        .tower-card.selected {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }
        
        .tower-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
        }
        
        .tower-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #00d4ff;
        }
        
        .tower-cost {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.2rem;
            margin: 5px 0;
        }
        
        .tower-stats {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 5px;
        }
        
        .shop {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            border: 2px solid #9d4edd;
        }
        
        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .shop-item {
            background: rgba(157, 78, 221, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .shop-item:hover {
            background: rgba(157, 78, 221, 0.3);
            transform: translateY(-2px);
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #00d4ff;
        }
        
        .enemy-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 0, 0, 0.1);
            border-radius: 5px;
        }
        
        .enemy-icon {
            font-size: 1.5rem;
        }
        
        .wave-info {
            background: rgba(0, 212, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .wave-progress {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .wave-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #0099ff);
            width: 0%;
            transition: width 0.3s;
        }
        
        .game-over {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .game-over-content {
            background: linear-gradient(135deg, #0f3460, #1a365d);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 3px solid #00d4ff;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
        }
        
        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
            }
            
            .towers {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè∞ KINGDOM DEFENSE PRO</h1>
            <p>Juego de Estrategia Mejorado - Defiende tu reino con t√°ctica</p>
        </header>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-label">üí∞ ORO</div>
                <div class="stat-value" id="gold">1000</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">‚öîÔ∏è OLEADA</div>
                <div class="stat-value" id="wave">1</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">‚ù§Ô∏è VIDAS</div>
                <div class="stat-value" id="lives">30</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">üéØ PUNTOS</div>
                <div class="stat-value" id="points">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">üíé GEMAS</div>
                <div class="stat-value" id="gems">50</div>
            </div>
        </div>
        
        <div class="game-area">
            <div class="game-board">
                <canvas id="gameCanvas" width="800" height="600"></canvas>
                <div class="grid-overlay" id="gridOverlay"></div>
                
                <div class="controls">
                    <button class="btn" id="startWave">
                        <span>‚ñ∂Ô∏è</span> Iniciar Oleada (1-10)
                    </button>
                    <button class="btn" id="upgradeAll">
                        <span>‚ö°</span> Mejorar Todas (200 oro)
                    </button>
                    <button class="btn" id="sellTower">
                        <span>üí∞</span> Vender Torre (75%)
                    </button>
                    <button class="btn btn-premium" id="specialPower">
                        <span>‚ú®</span> Poder Especial (10 gemas)
                    </button>
                </div>
                
                <div class="wave-info">
                    <h3>üìä Progreso de Oleada</h3>
                    <div class="wave-progress">
                        <div class="wave-progress-bar" id="waveProgress"></div>
                    </div>
                    <p id="waveStatus">Preparando defensas...</p>
                </div>
            </div>
            
            <div class="game-info">
                <h2 style="color: #00d4ff; margin-bottom: 15px;">üèóÔ∏è CONSTRUIR TORRES</h2>
                <p style="color: #aaa; margin-bottom: 15px;">Selecciona una torre y haz clic en una casilla verde para construir</p>
                
                <div class="towers">
                    <div class="tower-card" data-tower="archer" data-cost="150">
                        <div class="tower-icon">üèπ</div>
                        <div class="tower-name">Arquero √âlite</div>
                        <div class="tower-cost">150 ü™ô</div>
                        <div class="tower-stats">üéØ Da√±o: 15 ‚ö° Vel: R√°pida</div>
                    </div>
                    
                    <div class="tower-card" data-tower="mage" data-cost="300">
                        <div class="tower-icon">üîÆ</div>
                        <div class="tower-name">Mago Arcano</div>
                        <div class="tower-cost">300 ü™ô</div>
                        <div class="tower-stats">üéØ Da√±o: 35 ‚ö° Vel: Media</div>
                    </div>
                    
                    <div class="tower-card" data-tower="cannon" data-cost="400">
                        <div class="tower-icon">üí£</div>
                        <div class="tower-name">Ca√±√≥n Pesado</div>
                        <div class="tower-cost">400 ü™ô</div>
                        <div class="tower-stats">üéØ Da√±o: 50 ‚ö° Vel: Lenta</div>
                    </div>
                    
                    <div class="tower-card" data-tower="ice" data-cost="250">
                        <div class="tower-icon">‚ùÑÔ∏è</div>
                        <div class="tower-name">Torre Glacial</div>
                        <div class="tower-cost">250 ü™ô</div>
                        <div class="tower-stats">üéØ Da√±o: 10 ‚ö° Ralentiza</div>
                    </div>
                </div>
                
                <div class="instructions">
                    <h3 style="color: #ff6b00; margin-bottom: 10px;">üéÆ C√ìMO JUGAR</h3>
                    <ul style="list-style: none; padding-left: 0;">
                        <li style="margin-bottom: 8px;">‚úÖ <strong>Casillas verdes</strong> = Zonas para construir</li>
                        <li style="margin-bottom: 8px;">‚úÖ Cada torre tiene <strong>estad√≠sticas √∫nicas</strong></li>
                        <li style="margin-bottom: 8px;">‚úÖ Los enemigos siguen el <strong>camino marr√≥n</strong></li>
                        <li style="margin-bottom: 8px;">‚úÖ <strong>Mejora torres</strong> para m√°s da√±o</li>
                        <li style="margin-bottom: 8px;">‚úÖ Sobrevive a <strong>10 oleadas</strong> para ganar</li>
                    </ul>
                </div>
                
                <div class="enemy-info">
                    <div class="enemy-icon">üëπ</div>
                    <div>
                        <div><strong>Enemigos Activos:</strong> <span id="enemyCount">0</span></div>
                        <div><strong>Siguiente oleada en:</strong> <span id="nextWaveTimer">--</span>s</div>
                    </div>
                </div>
                
                <div class="shop">
                    <h2 style="color: #9d4edd; margin-bottom: 15px;">üõí TIENDA PREMIUM</h2>
                    
                    <div class="shop-items">
                        <div class="shop-item" onclick="buyItem('gold', 500, 5)">
                            <div style="font-size: 1.8rem; color: #ffd700;">ü™ô</div>
                            <div>+500 Oro</div>
                            <div style="margin: 8px 0; color: #9d4edd;">5 üíé</div>
                        </div>
                        
                        <div class="shop-item" onclick="buyItem('lives', 10, 8)">
                            <div style="font-size: 1.8rem; color: #ff4444;">‚ù§Ô∏è</div>
                            <div>+10 Vidas</div>
                            <div style="margin: 8px 0; color: #9d4edd;">8 üíé</div>
                        </div>
                        
                        <div class="shop-item" onclick="buyItem('damage', 2, 15)">
                            <div style="font-size: 1.8rem; color: #00d4ff;">‚ö°</div>
                            <div>x2 Da√±o 30s</div>
                            <div style="margin: 8px 0; color: #9d4edd;">15 üíé</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.4); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
            <p>üéÆ <strong>Juego de estrategia mejorado</strong> - Balance perfecto - Gr√°ficos optimizados</p>
            <p style="font-size: 0.9rem; margin-top: 10px; color: #aaa;">Las compras son opcionales. Juego 100% legal sin apuestas.</p>
        </div>
    </div>
    
    <!-- Pantalla de Game Over -->
    <div class="game-over" id="gameOver">
        <div class="game-over-content">
            <h2 id="gameOverTitle" style="color: #00d4ff; margin-bottom: 20px;">üèÜ ¬°VICTORIA!</h2>
            <div id="victoryIcon" style="font-size: 5rem; margin: 20px 0;">üëë</div>
            <p id="gameOverMessage" style="margin-bottom: 20px;">Has completado todas las oleadas</p>
            
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
                <div style="font-size: 2.5rem; color: #ffd700; margin: 10px 0;" id="finalScore">0 Puntos</div>
                <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                    <div>
                        <div style="color: #aaa;">Oleadas</div>
                        <div style="color: #00d4ff; font-size: 1.5rem;" id="finalWaves">0</div>
                    </div>
                    <div>
                        <div style="color: #aaa">Torres</div>
                        <div style="color: #00d4ff; font-size: 1.5rem;" id="finalTowers">0</div>
                    </div>
                    <div>
                        <div style="color: #aaa">Enemigos</div>
                        <div style="color: #00d4ff; font-size: 1.5rem;" id="finalEnemies">0</div>
                    </div>
                </div>
            </div>
            
            <div style="margin: 30px 0;">
                <button class="btn" id="playAgain" style="margin: 5px;">
                    <span>üîÑ</span> Jugar Otra Vez
                </button>
                <button class="btn btn-premium" id="continueGame" style="margin: 5px;">
                    <span>üöÄ</span> Continuar (Oleadas 11-20)
                </button>
            </div>
            
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px;">
                <p>¬øQuieres registrar tu r√©cord?</p>
                <button class="btn" id="shareScore" style="width: 100%; margin-top: 10px;">
                    <span>üì§</span> Compartir Puntaje
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN MEJORADA DEL JUEGO
        // ============================================
        
        // Variables del juego
        let gold = 1000;
        let wave = 1;
        let lives = 30;
        let points = 0;
        let gems = 50;
        let gameRunning = false;
        let selectedTower = null;
        let towers = [];
        let enemies = [];
        let bullets = [];
        let enemyKills = 0;
        let maxWaves = 10;
        let waveTimer = 0;
        let specialPowerActive = false;
        
        // Referencias a elementos del DOM
        const goldEl = document.getElementById('gold');
        const waveEl = document.getElementById('wave');
        const livesEl = document.getElementById('lives');
        const pointsEl = document.getElementById('points');
        const gemsEl = document.getElementById('gems');
        const enemyCountEl = document.getElementById('enemyCount');
        const nextWaveTimerEl = document.getElementById('nextWaveTimer');
        const waveProgressEl = document.getElementById('waveProgress');
        const waveStatusEl = document.getElementById('waveStatus');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gridOverlay = document.getElementById('gridOverlay');
        const gameOverScreen = document.getElementById('gameOver');
        
        // Configuraci√≥n del juego MEJORADA
        const GRID_SIZE = 60; // M√°s grande para mejor visibilidad
        const GRID_WIDTH = Math.floor(canvas.width / GRID_SIZE);
        const GRID_HEIGHT = Math.floor(canvas.height / GRID_SIZE);
        
        // Definir camino claramente (coordenadas de casillas)
        const PATH_CELLS = [
            // Camino horizontal superior
            {x: 0, y: 3}, {x: 1, y: 3}, {x: 2, y: 3}, {x: 3, y: 3}, {x: 4, y: 3},
            // Camino vertical derecha
            {x: 4, y: 4}, {x: 4, y: 5}, {x: 4, y: 6},
            // Camino horizontal inferior
            {x: 3, y: 6}, {x: 2, y: 6}, {x: 1, y: 6},
            // Camino vertical izquierda
            {x: 1, y: 7}, {x: 1, y: 8},
            // Camino horizontal final
            {x: 2, y: 8}, {x: 3, y: 8}, {x: 4, y: 8}, {x: 5, y: 8}, {x: 6, y: 8}, {x: 7, y: 8},
            // Base final (casilla de salida)
            {x: 8, y: 8}
        ];
        
        // Base del jugador (casilla final)
        const BASE_CELL = {x: 8, y: 8};
        
        // Torres MEJORADAS - M√°s balanceadas
        const TOWER_TYPES = {
            archer: {
                name: "Arquero √âlite",
                color: '#4CAF50',
                icon: 'üèπ',
                range: 180,
                damage: 25, // AUMENTADO
                speed: 25, // M√°s r√°pido
                cost: 150,
                level: 1,
                upgradeCost: 100,
                bulletColor: '#4CAF50',
                bulletSpeed: 8
            },
            mage: {
                name: "Mago Arcano",
                color: '#9C27B0',
                icon: 'üîÆ',
                range: 220,
                damage: 50, // AUMENTADO
                speed: 40,
                cost: 300,
                level: 1,
                upgradeCost: 150,
                bulletColor: '#9C27B0',
                bulletSpeed: 6
            },
            cannon: {
                name: "Ca√±√≥n Pesado",
                color: '#FF9800',
                icon: 'üí£',
                range: 150,
                damage: 80, // AUMENTADO
                speed: 60,
                cost: 400,
                level: 1,
                upgradeCost: 200,
                bulletColor: '#FF9800',
                bulletSpeed: 4,
                splash: true,
                splashRadius: 40
            },
            ice: {
                name: "Torre Glacial",
                color: '#00BCD4',
                icon: '‚ùÑÔ∏è',
                range: 200,
                damage: 15,
                speed: 35,
                cost: 250,
                level: 1,
                upgradeCost: 120,
                bulletColor: '#00BCD4',
                bulletSpeed: 7,
                slow: true,
                slowAmount: 0.5 // Reduce velocidad a la mitad
            }
        };
        
        // Enemigos MEJORADOS - Menos vida, m√°s variedad
        const ENEMY_TYPES = [
            {
                name: "Goblin",
                color: '#4CAF50',
                icon: 'üëπ',
                speed: 1.2,
                health: 40, // REDUCIDO
                reward: 20,
                points: 10
            },
            {
                name: "Orco",
                color: '#FF5722',
                icon: 'üë∫',
                speed: 0.8,
                health: 80,
                reward: 40,
                points: 20
            },
            {
                name: "Trol",
                color: '#795548',
                icon: 'üë£',
                speed: 0.5,
                health: 150,
                reward: 80,
                points: 40
            },
            {
                name: "Drag√≥n",
                color: '#F44336',
                icon: 'üê≤',
                speed: 1.5,
                health: 60,
                reward: 60,
                points: 30,
                flying: true
            }
        ];
        
        // ============================================
        // FUNCIONES DEL JUEGO
        // ============================================
        
        // Actualizar estad√≠sticas en pantalla
        function updateStats() {
            goldEl.textContent = gold;
            waveEl.textContent = wave;
            livesEl.textContent = lives;
            pointsEl.textContent = points;
            gemsEl.textContent = gems;
            enemyCountEl.textContent = enemies.length;
            
            if (gameRunning && enemies.length === 0 && wave <= maxWaves) {
                nextWaveTimerEl.textContent = Math.max(0, Math.ceil(waveTimer / 60));
            } else {
                nextWaveTimerEl.textContent = '--';
            }
        }
        
        // Inicializar el juego
        function initGame() {
            towers = [];
            enemies = [];
            bullets = [];
            gold = 1000; // M√ÅS ORO INICIAL
            wave = 1;
            lives = 30; // M√ÅS VIDAS
            points = 0;
            enemyKills = 0;
            gameRunning = false;
            specialPowerActive = false;
            waveTimer = 0;
            
            updateStats();
            createGrid();
            drawGame();
            
            waveStatusEl.textContent = 'Preparando defensas... Construye torres en casillas verdes';
            waveProgressEl.style.width = '0%';
        }
        
        // Crear cuadr√≠cula visual
        function createGrid() {
            gridOverlay.innerHTML = '';
            
            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = 0; x < GRID_WIDTH; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    
                    // Verificar si es parte del camino
                    const isPath = PATH_CELLS.some(p => p.x === x && p.y === y);
                    const isBase = BASE_CELL.x === x && BASE_CELL.y === y;
                    
                    if (isPath || isBase) {
                        cell.classList.add('path-cell');
                    } else {
                        // Solo algunas casillas son construibles (no todas)
                        const canBuild = Math.random() > 0.3 && y > 1 && y < GRID_HEIGHT - 2 && x > 1 && x < GRID_WIDTH - 2;
                        if (canBuild) {
                            cell.classList.add('buildable');
                            cell.dataset.x = x;
                            cell.dataset.y = y;
                            cell.style.cursor = 'pointer';
                            
                            // Hacer clic para construir
                            cell.addEventListener('click', function() {
                                const cellX = parseInt(this.dataset.x);
                                const cellY = parseInt(this.dataset.y);
                                buildTowerAt(cellX, cellY);
                            });
                            
                            // Efecto hover
                            cell.addEventListener('mouseenter', function() {
                                if (selectedTower) {
                                    this.style.background = 'rgba(0, 255, 0, 0.3)';
                                }
                            });
                            
                            cell.addEventListener('mouseleave', function() {
                                if (selectedTower) {
                                    this.style.background = 'rgba(0, 255, 0, 0.1)';
                                }
                            });
                        }
                    }
                    
                    cell.style.width = GRID_SIZE + 'px';
                    cell.style.height = GRID_SIZE + 'px';
                    cell.style.left = (x * GRID_SIZE) + 'px';
                    cell.style.top = (y * GRID_SIZE) + 'px';
                    
                    gridOverlay.appendChild(cell);
                }
            }
        }
        
        // Dibujar el juego
        function drawGame() {
            // Limpiar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Dibujar fondo
            ctx.fillStyle = '#0f3460';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Dibujar camino
            drawPath();
            
            // Dibujar base del jugador
            drawBase();
            
            // Dibujar torres
            towers.forEach(tower => {
                drawTower(tower);
                
                // Dibujar rango si est√° seleccionada
                if (tower.selected) {
                    drawTowerRange(tower);
                }
            });
            
            // Dibujar enemigos
            enemies.forEach(enemy => {
                drawEnemy(enemy);
            });
            
            // Dibujar balas/efectos
            bullets.forEach(bullet => {
                drawBullet(bullet);
            });
            
            // Dibujar efectos especiales
            if (specialPowerActive) {
                drawSpecialPowerEffect();
            }
        }
        
        // Dibujar camino
        function drawPath() {
            ctx.fillStyle = '#8B4513';
            
            PATH_CELLS.forEach(cell => {
                const x = cell.x * GRID_SIZE;
                const y = cell.y * GRID_SIZE;
                
                // Camino principal
                ctx.fillRect(x, y, GRID_SIZE, GRID_SIZE);
                
                // Borde del camino
                ctx.strokeStyle = '#A0522D';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, GRID_SIZE, GRID_SIZE);
                
                // Flechas direccionales (opcional)
                if (cell.x < GRID_WIDTH - 1) {
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.moveTo(x + GRID_SIZE/2, y + GRID_SIZE/2);
                    ctx.lineTo(x + GRID_SIZE - 10, y + GRID_SIZE/2);
                    ctx.lineTo(x + GRID_SIZE/2 + 5, y + GRID_SIZE/2);
                    ctx.fill();
                }
            });
        }
        
        // Dibujar base del jugador
        function drawBase() {
            const x = BASE_CELL.x * GRID_SIZE;
            const y = BASE_CELL.y * GRID_SIZE;
            
            // Base
            ctx.fillStyle = '#00d4ff';
            ctx.fillRect(x, y, GRID_SIZE, GRID_SIZE);
            
            // Detalles de la base
            ctx.fillStyle = '#ffffff';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('üè∞', x + GRID_SIZE/2, y + GRID_SIZE/2);
            
            // Borde brillante
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 3;
            ctx.strokeRect(x, y, GRID_SIZE, GRID_SIZE);
        }
        
        // Dibujar torre
        function drawTower(tower) {
            const x = tower.x;
            const y = tower.y;
            
            // Base de la torre
            ctx.fillStyle = tower.color;
            ctx.beginPath();
            ctx.arc(x, y, 20, 0, Math.PI * 2);
            ctx.fill();
            
            // Borde de la torre
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Icono de la torre
            ctx.fillStyle = '#ffffff';
            ctx.font = '24px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(tower.icon, x, y);
            
            // Nivel de la torre
            ctx.font = '12px Arial';
            ctx.fillText(`Lv${tower.level}`, x, y + 25);
            
            // Efecto de selecci√≥n
            if (tower.selected) {
                ctx.strokeStyle = '#ffff00';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(x, y, 25, 0, Math.PI * 2);
                ctx.stroke();
            }
        }
        
        // Dibujar rango de la torre
        function drawTowerRange(tower) {
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(tower.x, tower.y, tower.range, 0, Math.PI * 2);
            ctx.stroke();
            
            // Relleno semitransparente
            ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.beginPath();
            ctx.arc(tower.x, tower.y, tower.range, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Dibujar enemigo
        function drawEnemy(enemy) {
            const x = enemy.x;
            const y = enemy.y;
            
            // Cuerpo del enemigo
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.arc(x, y, 15, 0, Math.PI * 2);
            ctx.fill();
            
            // Icono del enemigo
            ctx.fillStyle = '#ffffff';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(enemy.icon, x, y);
            
            // Barra de vida
            const healthWidth = 40;
            const healthPercent = enemy.health / enemy.maxHealth;
            
            // Fondo de la barra
            ctx.fillStyle = '#ff5252';
            ctx.fillRect(x - healthWidth/2, y - 25, healthWidth, 6);
            
            // Vida actual
            ctx.fillStyle = '#4CAF50';
            ctx.fillRect(x - healthWidth/2, y - 25, healthWidth * healthPercent, 6);
            
            // Borde de la barra
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 1;
            ctx.strokeRect(x - healthWidth/2, y - 25, healthWidth, 6);
        }
        
        // Dibujar bala/efecto
        function drawBullet(bullet) {
            const x = bullet.x;
            const y = bullet.y;
            
            // Bala principal
            ctx.fillStyle = bullet.color;
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, Math.PI * 2);
            ctx.fill();
            
            // Efecto de brillo
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(x, y, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // Efecto de estela (para balas r√°pidas)
            if (bullet.speed > 6) {
                ctx.strokeStyle = bullet.color + '80';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(bullet.prevX || x, bullet.prevY || y);
                ctx.lineTo(x, y);
                ctx.stroke();
            }
            
            // Guardar posici√≥n anterior para la estela
            bullet.prevX = x;
            bullet.prevY = y;
        }
        
        // Dibujar efecto de poder especial
        function drawSpecialPowerEffect() {
            const time = Date.now() / 1000;
            const radius = 20 + Math.sin(time * 10) * 5;
            
            // Efecto de onda expansiva
            ctx.strokeStyle = '#ffff00';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(canvas.width/2, canvas.height/2, radius * 5, 0, Math.PI * 2);
            ctx.stroke();
            
            // Part√≠culas brillantes
            for (let i = 0; i < 20; i++) {
                const angle = (time * 2 + i * 0.3) % (Math.PI * 2);
                const px = canvas.width/2 + Math.cos(angle) * radius * 3;
                const py = canvas.height/2 + Math.sin(angle) * radius * 3;
                
                ctx.fillStyle = '#ffff00';
                ctx.beginPath();
                ctx.arc(px, py, 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        // Construir torre en posici√≥n espec√≠fica
        function buildTowerAt(gridX, gridY) {
            if (!selectedTower || gold < selectedTower.cost) {
                alert(selectedTower ? `Necesitas ${selectedTower.cost} oro para construir esta torre` : 'Selecciona una torre primero');
                return false;
            }
            
            // Verificar que no haya otra torre en esa posici√≥n
            const towerExists = towers.some(tower => {
                const tGridX = Math.floor(tower.x / GRID_SIZE);
                const tGridY = Math.floor(tower.y / GRID_SIZE);
                return tGridX === gridX && tGridY === gridY;
            });
            
            if (towerExists) {
                alert('Ya hay una torre en esta posici√≥n');
                return false;
            }
            
            // Verificar que no sea en el camino
            const isPath = PATH_CELLS.some(p => p.x === gridX && p.y === gridY);
            if (isPath) {
                alert('No puedes construir en el camino');
                return false;
            }
            
            const towerType = TOWER_TYPES[selectedTower.type];
            const x = gridX * GRID_SIZE + GRID_SIZE/2;
            const y = gridY * GRID_SIZE + GRID_SIZE/2;
            
            towers.push({
                x: x,
                y: y,
                type: selectedTower.type,
                color: towerType.color,
                icon: towerType.icon,
                range: towerType.range,
                damage: towerType.damage,
                speed: towerType.speed,
                level: 1,
                cooldown: 0,
                selected: false,
                upgradeCost: towerType.upgradeCost,
                bulletColor: towerType.bulletColor,
                bulletSpeed: towerType.bulletSpeed,
                splash: towerType.splash,
                splashRadius: towerType.splashRadius,
                slow: towerType.slow,
                slowAmount: towerType.slowAmount
            });
            
            gold -= selectedTower.cost;
            updateStats();
            drawGame();
            
            // Deseleccionar torre despu√©s de construir
            selectedTower = null;
            document.querySelectorAll('.tower-card.selected').forEach(c => c.classList.remove('selected'));
            
            return true;
        }
        
        // Crear una nueva oleada de enemigos
        function spawnWave() {
            const baseEnemies = 3 + wave;
            const waveEnemies = [];
            
            for (let i = 0; i < baseEnemies; i++) {
                // Enemigos m√°s fuertes en oleadas posteriores
                const enemyTypeIndex = Math.min(Math.floor((wave - 1) / 3), ENEMY_TYPES.length - 1);
                const enemyType = ENEMY_TYPES[enemyTypeIndex];
                
                waveEnemies.push({
                    x: 0 * GRID_SIZE + GRID_SIZE/2,
                    y: 3 * GRID_SIZE + GRID_SIZE/2,
                    type: enemyType,
                    color: enemyType.color,
                    icon: enemyType.icon,
                    speed: enemyType.speed * (0.8 + Math.random() * 0.4), // Variaci√≥n de velocidad
                    health: enemyType.health * (0.9 + wave * 0.1), // M√°s salud en oleadas altas
                    maxHealth: enemyType.health * (0.9 + wave * 0.1),
                    reward: enemyType.reward + wave * 5, // M√°s recompensa
                    points: enemyType.points + wave * 2,
                    pathIndex: 0,
                    slowEffect: 1 // 1 = velocidad normal, <1 = ralentizado
                });
            }
            
            enemies = enemies.concat(waveEnemies);
            waveStatusEl.textContent = `¬°Oleada ${wave} iniciada! ${enemies.length} enemigos entrando`;
            waveProgressEl.style.width = '0%';
            
            wave++;
            updateStats();
        }
        
        // Actualizar l√≥gica del juego
        function updateGame() {
            if (!gameRunning) return;
            
            // Actualizar temporizador de oleada
            if (enemies.length === 0 && wave <= maxWaves) {
                waveTimer--;
                if (waveTimer <= 0) {
                    spawnWave();
                }
            }
            
            // Actualizar progreso de oleada
            if (enemies.length > 0) {
                const progress = 100 - (enemies.length / (3 + wave - 1)) * 100;
                waveProgressEl.style.width = `${Math.max(0, progress)}%`;
            }
            
            // Mover enemigos por el camino
            enemies.forEach((enemy, enemyIndex) => {
                if (enemy.pathIndex >= PATH_CELLS.length - 1) {
                    // Enemigo lleg√≥ a la base
                    enemies.splice(enemyIndex, 1);
                    lives = Math.max(0, lives - Math.ceil(enemy.maxHealth / 20));
                    
                    if (lives <= 0) {
                        endGame(false);
                    }
                    
                    updateStats();
                    return;
                }
                
                // Obtener siguiente punto del camino
                const nextCell = PATH_CELLS[enemy.pathIndex + 1];
                const targetX = nextCell.x * GRID_SIZE + GRID_SIZE/2;
                const targetY = nextCell.y * GRID_SIZE + GRID_SIZE/2;
                
                // Calcular direcci√≥n
                const dx = targetX - enemy.x;
                const dy = targetY - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 2) {
                    // Lleg√≥ al punto, avanzar al siguiente
                    enemy.pathIndex++;
                } else {
                    // Mover hacia el punto
                    const speed = enemy.speed * enemy.slowEffect;
                    enemy.x += (dx / distance) * speed;
                    enemy.y += (dy / distance) * speed;
                }
            });
            
            // Actualizar torres
            towers.forEach(tower => {
                tower.cooldown = Math.max(0, tower.cooldown - 1);
                
                // Encontrar enemigo en rango (el m√°s cercano a la base)
                let targetEnemy = null;
                let maxPathIndex = -1;
                
                enemies.forEach(enemy => {
                    const dx = enemy.x - tower.x;
                    const dy = enemy.y - tower.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance <= tower.range && enemy.pathIndex > maxPathIndex) {
                        targetEnemy = enemy;
                        maxPathIndex = enemy.pathIndex;
                    }
                });
                
                if (targetEnemy && tower.cooldown <= 0) {
                    // Disparar
                    const bullet = {
                        x: tower.x,
                        y: tower.y,
                        target: targetEnemy,
                        damage: tower.damage * (specialPowerActive ? 2 : 1), // Doble da√±o con poder especial
                        color: tower.bulletColor,
                        speed: tower.bulletSpeed,
                        tower: tower
                    };
                    
                    bullets.push(bullet);
                    tower.cooldown = tower.speed;
                }
            });
            
            // Actualizar balas
            bullets.forEach((bullet, bulletIndex) => {
                if (!bullet.target || bullet.target.health <= 0) {
                    bullets.splice(bulletIndex, 1);
                    return;
                }
                
                // Mover hacia el objetivo
                const dx = bullet.target.x - bullet.x;
                const dy = bullet.target.y - bullet.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 10) {
                    // Golpear al objetivo
                    bullet.target.health -= bullet.damage;
                    
                    // Aplicar efectos especiales
                    if (bullet.tower.slow && bullet.target.slowEffect > bullet.tower.slowAmount) {
                        bullet.target.slowEffect = bullet.tower.slowAmount;
                    }
                    
                    // Efecto splash
                    if (bullet.tower.splash) {
                        enemies.forEach(enemy => {
                            if (enemy !== bullet.target) {
                                const splashDx = enemy.x - bullet.x;
                                const splashDy = enemy.y - bullet.y;
                                const splashDistance = Math.sqrt(splashDx * splashDx + splashDy * splashDy);
                                
                                if (splashDistance <= bullet.tower.splashRadius) {
                                    enemy.health -= bullet.damage * 0.5; // Da√±o reducido por splash
                                }
                            }
                        });
                    }
                    
                    if (bullet.target.health <= 0) {
                        // Enemigo derrotado
                        gold += bullet.target.reward;
                        points += bullet.target.points;
                        enemyKills++;
                        
                        // Eliminar enemigo
                        const enemyIndex = enemies.indexOf(bullet.target);
                        if (enemyIndex > -1) {
                            enemies.splice(enemyIndex, 1);
                        }
                        
                        // Si no quedan enemigos y es la √∫ltima oleada
                        if (enemies.length === 0 && wave > maxWaves) {
                            endGame(true);
                        }
                    }
                    
                    bullets.splice(bulletIndex, 1);
                } else {
                    bullet.x += (dx / distance) * bullet.speed;
                    bullet.y += (dy / distance) * bullet.speed;
                }
            });
            
            // Limpiar enemigos muertos
            enemies = enemies.filter(enemy => enemy.health > 0);
            
            drawGame();
            updateStats();
        }
        
        // Mejorar todas las torres
        function upgradeAllTowers() {
            if (gold < 200) {
                alert('Necesitas 200 oro para mejorar todas las torres');
                return;
            }
            
            let upgraded = false;
            towers.forEach(tower => {
                if (tower.level < 5) {
                    tower.level++;
                    tower.damage *= 1.5;
                    tower.range *= 1.1;
                    tower.speed = Math.max(10, tower.speed * 0.9); // L√≠mite m√≠nimo de velocidad
                    upgraded = true;
                }
            });
            
            if (upgraded) {
                gold -= 200;
                updateStats();
                drawGame();
                alert('¬°Todas las torres mejoradas! Da√±o +50%, Rango +10%');
            } else {
                alert('Todas las torres ya est√°n al nivel m√°ximo (5)');
            }
        }
        
        // Vender torre seleccionada
        function sellSelectedTower() {
            const selectedTowerIndex = towers.findIndex(t => t.selected);
            
            if (selectedTowerIndex === -1) {
                alert('Selecciona una torre primero (haz clic en ella)');
                return;
            }
            
            const tower = towers[selectedTowerIndex];
            const refund = Math.floor(tower.cost * 0.75);
            
            if (confirm(`¬øVender torre ${tower.icon} por ${refund} oro?`)) {
                towers.splice(selectedTowerIndex, 1);
                gold += refund;
                updateStats();
                drawGame();
                alert(`Torre vendida por ${refund} oro`);
            }
        }
        
        // Activar poder especial
        function activateSpecialPower() {
            if (gems < 10) {
                alert('Necesitas 10 gemas para activar el poder especial');
                return;
            }
            
            if (confirm('¬øGastar 10 gemas para activar DOBLE DA√ëO por 15 segundos?')) {
                gems -= 10;
                specialPowerActive = true;
                updateStats();
                
                // Efecto visual
                document.body.style.boxShadow = '0 0 50px #ffff00';
                
                setTimeout(() => {
                    specialPowerActive = false;
                    document.body.style.boxShadow = '';
                    alert('Poder especial terminado');
                }, 15000);
            }
        }
        
        // Comprar item de la tienda
        function buyItem(type, amount, cost) {
            if (gems < cost) {
                alert(`Necesitas ${cost} gemas para esto`);
                return;
            }
            
            if (confirm(`¬øGastar ${cost} gemas por este beneficio?`)) {
                gems -= cost;
                
                switch(type) {
                    case 'gold':
                        gold += amount;
                        alert(`+${amount} oro a√±adido!`);
                        break;
                    case 'lives':
                        lives += amount;
                        alert(`+${amount} vidas!`);
                        break;
                    case 'damage':
                        specialPowerActive = true;
                        setTimeout(() => {
                            specialPowerActive = false;
                            alert('Poder de doble da√±o terminado');
                        }, 30000);
                        alert('¬°Doble da√±o activado por 30 segundos!');
                        break;
                }
                
                updateStats();
                drawGame();
            }
        }
        
        // Finalizar juego
        function endGame(victory) {
            gameRunning = false;
            
            const title = document.getElementById('gameOverTitle');
            const message = document.getElementById('gameOverMessage');
            const score = document.getElementById('finalScore');
            const victoryIcon = document.getElementById('victoryIcon');
            const finalWaves = document.getElementById('finalWaves');
            const finalTowers = document.getElementById('finalTowers');
            const finalEnemies = document.getElementById('finalEnemies');
            
            if (victory) {
                title.textContent = 'üèÜ ¬°VICTORIA TOTAL!';
                message.textContent = `Has defendido el reino por ${wave-1} oleadas`;
                victoryIcon.textContent = 'üëë';
                victoryIcon.style.color = '#ffd700';
                
                // Bono por victoria
                points += 1000;
                gems += 20;
            } else {
                title.textContent = 'üíÄ REINO CA√çDO';
                message.textContent = 'Los enemigos han conquistado tu reino';
                victoryIcon.textContent = 'üíÄ';
                victoryIcon.style.color = '#ff4444';
            }
            
            score.textContent = `${points} Puntos`;
            finalWaves.textContent = wave - 1;
            finalTowers.textContent = towers.length;
            finalEnemies.textContent = enemyKills;
            
            gameOverScreen.style.display = 'flex';
            updateStats();
        }
        
        // ============================================
        // EVENT LISTENERS
        // ============================================
        
        // Seleccionar torres
        document.querySelectorAll('.tower-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.tower-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                
                selectedTower = {
                    type: this.dataset.tower,
                    cost: parseInt(this.dataset.cost),
                    name: this.querySelector('.tower-name').textContent
                };
                
                // Deseleccionar torres en el mapa
                towers.forEach(t => t.selected = false);
                drawGame();
                
                alert(`Seleccionada: ${selectedTower.name} - ${selectedTower.cost} oro`);
            });
        });
        
        // Seleccionar torres en el mapa (para vender/mejorar)
        canvas.addEventListener('click', function(event) {
            const rect = canvas.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const clickY = event.clientY - rect.top;
            
            // Buscar torre clickeada
            let towerClicked = false;
            towers.forEach(tower => {
                const dx = clickX - tower.x;
                const dy = clickY - tower.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 25) {
                    // Deseleccionar todas primero
                    towers.forEach(t => t.selected = false);
                    
                    // Seleccionar esta torre
                    tower.selected = true;
                    towerClicked = true;
                    
                    alert(`Torre ${tower.icon} seleccionada\nNivel: ${tower.level}\nDa√±o: ${tower.damage}\nRango: ${tower.range}\nMejorar: ${tower.upgradeCost} oro`);
                }
            });
            
            if (towerClicked) {
                drawGame();
            }
        });
        
        // Botones de control
        document.getElementById('startWave').addEventListener('click', function() {
            if (!gameRunning) {
                gameRunning = true;
                waveTimer = 300; // 5 segundos a 60 FPS
                waveStatusEl.textContent = '¬°Preparate! La oleada comienza en 5 segundos...';
                alert('¬°El juego ha comenzado! Las oleadas vendr√°n autom√°ticamente.');
            }
        });
        
        document.getElementById('upgradeAll').addEventListener('click', upgradeAllTowers);
        document.getElementById('sellTower').addEventListener('click', sellSelectedTower);
        document.getElementById('specialPower').addEventListener('click', activateSpecialPower);
        
        // Botones de game over
        document.getElementById('playAgain').addEventListener('click', function() {
            gameOverScreen.style.display = 'none';
            initGame();
        });
        
        document.getElementById('continueGame').addEventListener('click', function() {
            if (gems >= 30) {
                gems -= 30;
                maxWaves = 20;
                gameOverScreen.style.display = 'none';
                gameRunning = true;
                waveTimer = 300;
                alert('¬°Modo EXTREMO desbloqueado! Oleadas 11-20. ¬°Buena suerte!');
                updateStats();
            } else {
                alert('Necesitas 30 gemas para continuar');
            }
        });
        
        document.getElementById('shareScore').addEventListener('click', function() {
            const shareText = `üéÆ ¬°Consegu√≠ ${points} puntos en Kingdom Defense! ¬øPodr√°s superarme? ${wave-1} oleadas, ${enemyKills} enemigos derrotados.`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Kingdom Defense Pro',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                prompt('Copia este mensaje para compartir:', shareText + '\n' + window.location.href);
            }
        });
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        
        // Iniciar el juego
        initGame();
        
        // Bucle del juego (60 FPS)
        setInterval(updateGame, 16);
        
        // Mensaje de bienvenida mejorado
        setTimeout(() => {
            alert(`üéÆ BIENVENIDO A KINGDOM DEFENSE PRO\n\nMEJORAS IMPLEMENTADAS:\n‚úÖ M√°s oro inicial (1000)\n‚úÖ M√°s vidas (30)\n‚úÖ Da√±o de torres AUMENTADO\n‚úÖ Enemigos con MENOS vida\n‚úÖ Zonas de construcci√≥n DEFINIDAS (casillas verdes)\n‚úÖ Gr√°ficos MEJORADOS\n‚úÖ Camino m√°s interesante\n‚úÖ Sistema de oleadas mejorado\n\n¬°Sobrevive a 10 oleadas para ganar!`);
        }, 500);
    </script>
</body>
</html>