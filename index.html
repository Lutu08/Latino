<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kingdom Defense Pro - Juego de Estrategia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a192f, #1a365d);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        
        h1 {
            color: #00d4ff;
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.7);
        }
        
        .game-area {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .game-board {
            flex: 3;
            min-width: 300px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #00d4ff;
            position: relative;
        }
        
        .game-info {
            flex: 1;
            min-width: 250px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #ff6b00;
        }
        
        #gameCanvas {
            width: 100%;
            height: 600px;
            background: #0f3460;
            border-radius: 10px;
            border: 2px solid #00d4ff;
            display: block;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
            cursor: crosshair;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: rgba(255, 107, 0, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 0, 0.3);
        }
        
        .stat-item {
            text-align: center;
            padding: 0 10px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #ff6b00;
            text-shadow: 0 0 10px rgba(255, 107, 0, 0.5);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            background: linear-gradient(45deg, #00d4ff, #0099ff);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 150px;
            justify-content: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-premium {
            background: linear-gradient(45deg, #ff6b00, #ff3d00);
        }
        
        .btn-premium:hover {
            box-shadow: 0 5px 15px rgba(255, 107, 0, 0.4);
        }
        
        .towers {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .tower-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .tower-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }
        
        .tower-card.selected {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }
        
        .tower-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
        }
        
        .tower-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #00d4ff;
        }
        
        .tower-cost {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.2rem;
            margin: 5px 0;
        }
        
        .tower-stats {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 5px;
        }
        
        .shop {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            border: 2px solid #9d4edd;
        }
        
        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .shop-item {
            background: rgba(157, 78, 221, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .shop-item:hover {
            background: rgba(157, 78, 221, 0.3);
            transform: translateY(-2px);
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #00d4ff;
        }
        
        .enemy-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 0, 0, 0.1);
            border-radius: 5px;
        }
        
        .enemy-icon {
            font-size: 1.5rem;
        }
        
        .wave-info {
            background: rgba(0, 212, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .wave-progress {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .wave-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #0099ff);
            width: 0%;
            transition: width 0.3s;
        }
        
        .game-over {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .game-over-content {
            background: linear-gradient(135deg, #0f3460, #1a365d);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 3px solid #00d4ff;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
        }
        
        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
            }
            
            .towers {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn {
                min-width: 100%;
            }
        }
        
        .status-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            border: 2px solid #00d4ff;
            z-index: 1000;
            display: none;
            font-weight: bold;
            text-align: center;
            max-width: 80%;
        }
    </style>
</head>
<body>
    <div class="status-message" id="statusMessage"></div>
    
    <div class="container">
        <header>
            <h1>üè∞ KINGDOM DEFENSE PRO</h1>
            <p>Juego de Estrategia - Defiende tu reino</p>
        </header>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-label">üí∞ ORO</div>
                <div class="stat-value" id="gold">1000</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">‚öîÔ∏è OLEADA</div>
                <div class="stat-value" id="wave">1</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">‚ù§Ô∏è VIDAS</div>
                <div class="stat-value" id="lives">30</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">üéØ PUNTOS</div>
                <div class="stat-value" id="points">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">üíé GEMAS</div>
                <div class="stat-value" id="gems">50</div>
            </div>
        </div>
        
        <div class="game-area">
            <div class="game-board">
                <canvas id="gameCanvas" width="800" height="600"></canvas>
                
                <div class="controls">
                    <button class="btn" id="startWave">
                        <span>‚ñ∂Ô∏è</span> Iniciar Oleada (1-10)
                    </button>
                    <button class="btn" id="upgradeAll">
                        <span>‚ö°</span> Mejorar Todas (200 oro)
                    </button>
                    <button class="btn" id="sellTower">
                        <span>üí∞</span> Vender Torre (75%)
                    </button>
                    <button class="btn btn-premium" id="specialPower">
                        <span>‚ú®</span> Poder Especial (10 gemas)
                    </button>
                </div>
                
                <div class="wave-info">
                    <h3>üìä Progreso de Oleada</h3>
                    <div class="wave-progress">
                        <div class="wave-progress-bar" id="waveProgress"></div>
                    </div>
                    <p id="waveStatus">Selecciona una torre y haz clic en una zona verde para construir</p>
                </div>
            </div>
            
            <div class="game-info">
                <h2 style="color: #00d4ff; margin-bottom: 15px;">üèóÔ∏è CONSTRUIR TORRES</h2>
                <p style="color: #aaa; margin-bottom: 15px;">Haz clic en una torre para seleccionarla, luego haz clic en una zona verde del mapa</p>
                
                <div class="towers">
                    <div class="tower-card" data-tower="archer" data-cost="150">
                        <div class="tower-icon">üèπ</div>
                        <div class="tower-name">Arquero √âlite</div>
                        <div class="tower-cost">150 ü™ô</div>
                        <div class="tower-stats">üéØ Da√±o: 25 ‚ö° Vel: R√°pida</div>
                    </div>
                    
                    <div class="tower-card" data-tower="mage" data-cost="300">
                        <div class="tower-icon">üîÆ</div>
                        <div class="tower-name">Mago Arcano</div>
                        <div class="tower-cost">300 ü™ô</div>
                        <div class="tower-stats">üéØ Da√±o: 40 ‚ö° Vel: Media</div>
                    </div>
                    
                    <div class="tower-card" data-tower="cannon" data-cost="400">
                        <div class="tower-icon">üí£</div>
                        <div class="tower-name">Ca√±√≥n Pesado</div>
                        <div class="tower-cost">400 ü™ô</div>
                        <div class="tower-stats">üéØ Da√±o: 65 ‚ö° Vel: Lenta</div>
                    </div>
                    
                    <div class="tower-card" data-tower="ice" data-cost="250">
                        <div class="tower-icon">‚ùÑÔ∏è</div>
                        <div class="tower-name">Torre Glacial</div>
                        <div class="tower-cost">250 ü™ô</div>
                        <div class="tower-stats">üéØ Da√±o: 15 ‚ö° Ralentiza</div>
                    </div>
                </div>
                
                <div class="instructions">
                    <h3 style="color: #ff6b00; margin-bottom: 10px;">üéÆ C√ìMO JUGAR</h3>
                    <ul style="list-style: none; padding-left: 0;">
                        <li style="margin-bottom: 8px;">‚úÖ <strong>Zonas verdes</strong> = Para construir torres</li>
                        <li style="margin-bottom: 8px;">‚úÖ <strong>Camino marr√≥n</strong> = Por donde vienen los enemigos</li>
                        <li style="margin-bottom: 8px;">‚úÖ <strong>Construye estrat√©gicamente</strong> para cubrir el camino</li>
                        <li style="margin-bottom: 8px;">‚úÖ <strong>Mejora torres</strong> para m√°s da√±o y alcance</li>
                        <li style="margin-bottom: 8px;">‚úÖ <strong>Sobrevive 10 oleadas</strong> para ganar</li>
                    </ul>
                </div>
                
                <div class="enemy-info">
                    <div class="enemy-icon">üëπ</div>
                    <div>
                        <div><strong>Enemigos Activos:</strong> <span id="enemyCount">0</span></div>
                        <div><strong>Siguiente oleada:</strong> <span id="nextWaveTimer">--</span>s</div>
                    </div>
                </div>
                
                <div class="shop">
                    <h2 style="color: #9d4edd; margin-bottom: 15px;">üõí TIENDA PREMIUM</h2>
                    
                    <div class="shop-items">
                        <div class="shop-item" id="buyGold">
                            <div style="font-size: 1.8rem; color: #ffd700;">ü™ô</div>
                            <div>+500 Oro</div>
                            <div style="margin: 8px 0; color: #9d4edd;">5 üíé</div>
                        </div>
                        
                        <div class="shop-item" id="buyLives">
                            <div style="font-size: 1.8rem; color: #ff4444;">‚ù§Ô∏è</div>
                            <div>+10 Vidas</div>
                            <div style="margin: 8px 0; color: #9d4edd;">8 üíé</div>
                        </div>
                        
                        <div class="shop-item" id="buyDamage">
                            <div style="font-size: 1.8rem; color: #00d4ff;">‚ö°</div>
                            <div>x2 Da√±o 30s</div>
                            <div style="margin: 8px 0; color: #9d4edd;">15 üíé</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.4); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
            <p>üéÆ <strong>Juego de estrategia</strong> - Defiende tu reino de las oleadas enemigas</p>
            <p style="font-size: 0.9rem; margin-top: 10px; color: #aaa;">Desarrollado con HTML5 Canvas y JavaScript</p>
        </div>
    </div>
    
    <!-- Pantalla de Game Over -->
    <div class="game-over" id="gameOver">
        <div class="game-over-content">
            <h2 id="gameOverTitle" style="color: #00d4ff; margin-bottom: 20px;">üèÜ ¬°VICTORIA!</h2>
            <div id="victoryIcon" style="font-size: 5rem; margin: 20px 0;">üëë</div>
            <p id="gameOverMessage" style="margin-bottom: 20px;">Has completado todas las oleadas</p>
            
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
                <div style="font-size: 2.5rem; color: #ffd700; margin: 10px 0;" id="finalScore">0 Puntos</div>
                <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                    <div>
                        <div style="color: #aaa;">Oleadas</div>
                        <div style="color: #00d4ff; font-size: 1.5rem;" id="finalWaves">0</div>
                    </div>
                    <div>
                        <div style="color: #aaa">Torres</div>
                        <div style="color: #00d4ff; font-size: 1.5rem;" id="finalTowers">0</div>
                    </div>
                    <div>
                        <div style="color: #aaa">Enemigos</div>
                        <div style="color: #00d4ff; font-size: 1.5rem;" id="finalEnemies">0</div>
                    </div>
                </div>
            </div>
            
            <div style="margin: 30px 0;">
                <button class="btn" id="playAgain" style="margin: 5px;">
                    <span>üîÑ</span> Jugar Otra Vez
                </button>
                <button class="btn btn-premium" id="continueGame" style="margin: 5px;">
                    <span>üöÄ</span> Continuar (Oleadas 11-20)
                </button>
            </div>
            
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px;">
                <p>¬øQuieres registrar tu r√©cord?</p>
                <button class="btn" id="shareScore" style="width: 100%; margin-top: 10px;">
                    <span>üì§</span> Compartir Puntaje
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // JUEGO COMPLETO - CONSTRUCCI√ìN DE TORRES FUNCIONAL
        // ============================================
        
        // Variables del juego
        let gold = 1000;
        let wave = 1;
        let lives = 30;
        let points = 0;
        let gems = 50;
        let gameRunning = false;
        let selectedTower = null;
        let towers = [];
        let enemies = [];
        let bullets = [];
        let enemyKills = 0;
        let maxWaves = 10;
        let waveTimer = 0;
        let specialPowerActive = false;
        let damageBoostActive = false;
        let damageBoostEndTime = 0;
        
        // Estad√≠sticas de torres
        const towerStats = {
            archer: { 
                name: "Arquero √âlite", 
                damage: 25, 
                range: 120, 
                fireRate: 800, 
                cost: 150,
                color: '#00ff88',
                icon: 'üèπ'
            },
            mage: { 
                name: "Mago Arcano", 
                damage: 40, 
                range: 150, 
                fireRate: 1200, 
                cost: 300,
                color: '#ff00ff',
                icon: 'üîÆ'
            },
            cannon: { 
                name: "Ca√±√≥n Pesado", 
                damage: 65, 
                range: 100, 
                fireRate: 1500, 
                cost: 400,
                color: '#ff8800',
                icon: 'üí£'
            },
            ice: { 
                name: "Torre Glacial", 
                damage: 15, 
                range: 110, 
                fireRate: 1000, 
                cost: 250,
                color: '#00ffff',
                icon: '‚ùÑÔ∏è',
                slow: 0.7
            }
        };
        
        // Referencias a elementos del DOM
        const goldEl = document.getElementById('gold');
        const waveEl = document.getElementById('wave');
        const livesEl = document.getElementById('lives');
        const pointsEl = document.getElementById('points');
        const gemsEl = document.getElementById('gems');
        const enemyCountEl = document.getElementById('enemyCount');
        const nextWaveTimerEl = document.getElementById('nextWaveTimer');
        const waveProgressEl = document.getElementById('waveProgress');
        const waveStatusEl = document.getElementById('waveStatus');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameOverScreen = document.getElementById('gameOver');
        const statusMessageEl = document.getElementById('statusMessage');
        
        // Zonas de construcci√≥n (coordenadas en el canvas)
        const buildZones = [
            // Fila superior
            {x: 80, y: 200, width: 40, height: 40},
            {x: 160, y: 200, width: 40, height: 40},
            {x: 240, y: 200, width: 40, height: 40},
            {x: 320, y: 200, width: 40, height: 40},
            
            // Fila media superior
            {x: 120, y: 240, width: 40, height: 40},
            {x: 200, y: 240, width: 40, height: 40},
            {x: 280, y: 240, width: 40, height: 40},
            
            // Fila media inferior
            {x: 120, y: 320, width: 40, height: 40},
            {x: 200, y: 320, width: 40, height: 40},
            {x: 280, y: 320, width: 40, height: 40},
            
            // Fila inferior
            {x: 80, y: 360, width: 40, height: 40},
            {x: 160, y: 360, width: 40, height: 40},
            {x: 240, y: 360, width: 40, height: 40},
            {x: 320, y: 360, width: 40, height: 40},
            
            // Columnas laterales
            {x: 40, y: 240, width: 40, height: 40},
            {x: 40, y: 280, width: 40, height: 40},
            {x: 40, y: 320, width: 40, height: 40},
            {x: 360, y: 240, width: 40, height: 40},
            {x: 360, y: 280, width: 40, height: 40},
            {x: 360, y: 320, width: 40, height: 40}
        ];
        
        // ============================================
        // FUNCIONES PRINCIPALES
        // ============================================
        
        // Mostrar mensaje temporal
        function showMessage(text, type = "info") {
            statusMessageEl.textContent = text;
            
            const colors = {
                info: "#00d4ff",
                success: "#00ff00",
                warning: "#ffaa00",
                error: "#ff4444"
            };
            
            statusMessageEl.style.borderColor = colors[type] || colors.info;
            statusMessageEl.style.display = "block";
            
            setTimeout(() => {
                statusMessageEl.style.display = "none";
            }, 3000);
        }
        
        // Verificar si un punto est√° en el camino
        function isOnPath(x, y) {
            // Camino horizontal superior
            if (y >= 120 && y <= 160 && x >= 0 && x <= 360) return true;
            // Camino vertical derecho
            if (x >= 360 && x <= 400 && y >= 120 && y <= 440) return true;
            // Camino horizontal inferior
            if (y >= 440 && y <= 480 && x >= 40 && x <= 360) return true;
            
            return false;
        }
        
        // Verificar si un punto est√° en zona de construcci√≥n
        function isInBuildZone(x, y) {
            for (const zone of buildZones) {
                if (x >= zone.x && x <= zone.x + zone.width &&
                    y >= zone.y && y <= zone.y + zone.height) {
                    return true;
                }
            }
            return false;
        }
        
        // Obtener zona de construcci√≥n en una posici√≥n
        function getBuildZoneAt(x, y) {
            for (const zone of buildZones) {
                if (x >= zone.x && x <= zone.x + zone.width &&
                    y >= zone.y && y <= zone.y + zone.height) {
                    return zone;
                }
            }
            return null;
        }
        
        // Construir torre
        function buildTower(type, x, y) {
            const stats = towerStats[type];
            
            // Verificar oro
            if (gold < stats.cost) {
                showMessage(`No tienes suficiente oro. Necesitas ${stats.cost}`, "error");
                return false;
            }
            
            // Verificar que no est√© en el camino
            if (isOnPath(x, y)) {
                showMessage("¬°No puedes construir en el camino!", "error");
                return false;
            }
            
            // Verificar que est√© en zona de construcci√≥n
            if (!isInBuildZone(x, y)) {
                showMessage("¬°Solo puedes construir en zonas verdes!", "error");
                return false;
            }
            
            // Verificar distancia con otras torres
            for (const tower of towers) {
                const dx = tower.x - x;
                const dy = tower.y - y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 40) {
                    showMessage("¬°Muy cerca de otra torre!", "error");
                    return false;
                }
            }
            
            // Crear torre
            gold -= stats.cost;
            
            const tower = {
                type: type,
                x: x,
                y: y,
                damage: stats.damage,
                range: stats.range,
                fireRate: stats.fireRate,
                lastShot: 0,
                level: 1,
                color: stats.color,
                icon: stats.icon,
                cost: stats.cost,
                slow: stats.slow || 1
            };
            
            towers.push(tower);
            updateUI();
            showMessage(`¬°${stats.name} construida por ${stats.cost} oro!`, "success");
            
            return true;
        }
        
        // Dibujar el camino
        function drawPath() {
            // Camino principal
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(0, 120, 360, 40);   // Horizontal superior
            ctx.fillRect(360, 120, 40, 320); // Vertical derecha
            ctx.fillRect(40, 440, 320, 40);  // Horizontal inferior
            
            // Bordes del camino
            ctx.strokeStyle = '#654321';
            ctx.lineWidth = 3;
            ctx.strokeRect(0, 120, 360, 40);
            ctx.strokeRect(360, 120, 40, 320);
            ctx.strokeRect(40, 440, 320, 40);
            
            // L√≠nea central punteada
            ctx.strokeStyle = '#DEB887';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 10]);
            ctx.beginPath();
            ctx.moveTo(0, 140);
            ctx.lineTo(360, 140);
            ctx.moveTo(380, 120);
            ctx.lineTo(380, 440);
            ctx.moveTo(40, 460);
            ctx.lineTo(360, 460);
            ctx.stroke();
            ctx.setLineDash([]);
        }
        
        // Dibujar zonas de construcci√≥n
        function drawBuildZones() {
            buildZones.forEach(zone => {
                ctx.fillStyle = 'rgba(0, 255, 0, 0.2)';
                ctx.fillRect(zone.x, zone.y, zone.width, zone.height);
                
                ctx.strokeStyle = 'rgba(0, 255, 0, 0.5)';
                ctx.lineWidth = 2;
                ctx.strokeRect(zone.x, zone.y, zone.width, zone.height);
            });
        }
        
        // Dibujar torres
        function drawTowers() {
            towers.forEach(tower => {
                // Base de la torre
                ctx.fillStyle = tower.color;
                ctx.beginPath();
                ctx.arc(tower.x + 20, tower.y + 20, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // Borde
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Icono
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(tower.icon, tower.x + 20, tower.y + 20);
                
                // Nivel
                ctx.fillStyle = 'white';
                ctx.font = 'bold 12px Arial';
                ctx.fillText(`Lv${tower.level}`, tower.x + 20, tower.y + 45);
            });
        }
        
        // Crear enemigo
        function createEnemy() {
            const baseHealth = 50 + (wave - 1) * 20;
            const baseSpeed = 1 + wave * 0.1;
            const baseBounty = 10 + wave * 5;
            
            let type = 'normal';
            let color = 'red';
            let size = 20;
            
            if (wave >= 5) {
                type = 'elite';
                color = 'purple';
                size = 25;
            }
            
            if (wave >= 8) {
                type = 'boss';
                color = 'orange';
                size = 30;
            }
            
            const enemy = {
                x: -30,
                y: 140,
                width: size,
                height: size,
                health: type === 'elite' ? baseHealth * 1.5 : type === 'boss' ? baseHealth * 3 : baseHealth,
                maxHealth: type === 'elite' ? baseHealth * 1.5 : type === 'boss' ? baseHealth * 3 : baseHealth,
                speed: type === 'boss' ? baseSpeed * 0.7 : baseSpeed,
                bounty: type === 'elite' ? baseBounty * 2 : type === 'boss' ? baseBounty * 5 : baseBounty,
                type: type,
                color: color,
                pathIndex: 0,
                path: [
                    {x: 0, y: 140},   // Inicio
                    {x: 350, y: 140}, // Derecha
                    {x: 350, y: 430}, // Abajo
                    {x: 50, y: 430},  // Izquierda
                    {x: 50, y: 470}   // Fin
                ]
            };
            
            enemies.push(enemy);
        }
        
        // Dibujar enemigos
        function drawEnemies() {
            enemies.forEach(enemy => {
                // Cuerpo
                ctx.fillStyle = enemy.color;
                ctx.beginPath();
                ctx.arc(enemy.x, enemy.y, enemy.width/2, 0, Math.PI * 2);
                ctx.fill();
                
                // Borde
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Barra de vida
                const healthPercent = enemy.health / enemy.maxHealth;
                const barWidth = 30;
                const barHeight = 5;
                const barX = enemy.x - barWidth/2;
                const barY = enemy.y - enemy.width/2 - 10;
                
                ctx.fillStyle = 'red';
                ctx.fillRect(barX, barY, barWidth, barHeight);
                
                ctx.fillStyle = 'lime';
                ctx.fillRect(barX, barY, barWidth * healthPercent, barHeight);
                
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 1;
                ctx.strokeRect(barX, barY, barWidth, barHeight);
            });
        }
        
        // Dibujar balas
        function drawBullets() {
            bullets.forEach(bullet => {
                ctx.fillStyle = bullet.color;
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, 5, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(bullet.x - 2, bullet.y - 2, 2, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        // Actualizar torres (disparar)
        function updateTowers(currentTime) {
            towers.forEach(tower => {
                // Buscar enemigo en rango
                let target = null;
                let closestDistance = tower.range;
                
                enemies.forEach(enemy => {
                    const dx = (tower.x + 20) - enemy.x;
                    const dy = (tower.y + 20) - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < closestDistance) {
                        closestDistance = distance;
                        target = enemy;
                    }
                });
                
                // Disparar
                if (target && currentTime - tower.lastShot > tower.fireRate) {
                    let damage = tower.damage;
                    if (damageBoostActive) damage *= 2;
                    
                    bullets.push({
                        x: tower.x + 20,
                        y: tower.y + 20,
                        target: target,
                        damage: damage,
                        color: tower.color,
                        type: tower.type,
                        slow: tower.slow
                    });
                    
                    tower.lastShot = currentTime;
                }
            });
        }
        
        // Actualizar elementos del juego
        function updateGameElements() {
            // Mover enemigos
            enemies.forEach((enemy, index) => {
                if (enemy.pathIndex < enemy.path.length - 1) {
                    const target = enemy.path[enemy.pathIndex + 1];
                    const dx = target.x - enemy.x;
                    const dy = target.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < enemy.speed) {
                        enemy.pathIndex++;
                        enemy.x = target.x;
                        enemy.y = target.y;
                    } else {
                        enemy.x += (dx / distance) * enemy.speed;
                        enemy.y += (dy / distance) * enemy.speed;
                    }
                } else {
                    // Enemigo lleg√≥ al final
                    lives--;
                    enemies.splice(index, 1);
                    
                    if (lives <= 0) {
                        gameOver();
                    }
                    
                    updateUI();
                }
            });
            
            // Mover balas
            bullets.forEach((bullet, index) => {
                if (!bullet.target || bullet.target.health <= 0) {
                    bullets.splice(index, 1);
                    return;
                }
                
                const dx = bullet.target.x - bullet.x;
                const dy = bullet.target.y - bullet.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 10) {
                    // Impacto
                    bullet.target.health -= bullet.damage;
                    
                    // Efecto de ralentizaci√≥n
                    if (bullet.type === 'ice') {
                        bullet.target.speed *= bullet.slow;
                    }
                    
                    // Verificar si muri√≥
                    if (bullet.target.health <= 0) {
                        gold += bullet.target.bounty;
                        points += bullet.target.type === 'elite' ? 25 : bullet.target.type === 'boss' ? 50 : 10;
                        enemyKills++;
                        
                        const enemyIndex = enemies.indexOf(bullet.target);
                        if (enemyIndex !== -1) {
                            enemies.splice(enemyIndex, 1);
                        }
                    }
                    
                    bullets.splice(index, 1);
                } else {
                    bullet.x += (dx / distance) * 8;
                    bullet.y += (dy / distance) * 8;
                }
            });
        }
        
        // Dibujar todo
        function drawGame() {
            // Limpiar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Dibujar elementos
            drawBuildZones();
            drawPath();
            drawTowers();
            drawEnemies();
            drawBullets();
            
            // Dibujar boost activo
            if (damageBoostActive) {
                const timeLeft = Math.ceil((damageBoostEndTime - Date.now()) / 1000);
                if (timeLeft > 0) {
                    ctx.fillStyle = 'rgba(255, 215, 0, 0.7)';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`‚ö° x2 DA√ëO (${timeLeft}s)`, canvas.width / 2, 30);
                } else {
                    damageBoostActive = false;
                }
            }
        }
        
        // Actualizar interfaz
        function updateUI() {
            goldEl.textContent = gold;
            waveEl.textContent = wave;
            livesEl.textContent = lives;
            pointsEl.textContent = points;
            gemsEl.textContent = gems;
            enemyCountEl.textContent = enemies.length;
            
            // Progreso de oleada
            const progress = ((wave - 1) / maxWaves) * 100;
            waveProgressEl.style.width = `${progress}%`;
            
            // Temporizador
            if (waveTimer > 0) {
                nextWaveTimerEl.textContent = Math.ceil(waveTimer);
            } else {
                nextWaveTimerEl.textContent = '--';
            }
            
            // Actualizar boost
            if (damageBoostActive && Date.now() > damageBoostEndTime) {
                damageBoostActive = false;
                showMessage('El boost de da√±o ha terminado', "info");
            }
        }
        
        // Iniciar oleada
        function startWave() {
            if (gameRunning) {
                showMessage("¬°Ya hay una oleada en progreso!", "error");
                return;
            }
            
            gameRunning = true;
            waveStatusEl.textContent = `¬°Oleada ${wave} iniciada!`;
            
            // Crear enemigos
            const enemyCount = 5 + wave * 2;
            
            for (let i = 0; i < enemyCount; i++) {
                setTimeout(() => {
                    createEnemy();
                }, i * 1000);
            }
            
            showMessage(`¬°Oleada ${wave} iniciada! ${enemyCount} enemigos se acercan`, "warning");
        }
        
        // Verificar fin de oleada
        function checkWaveEnd() {
            if (gameRunning && enemies.length === 0) {
                // Buscar si hay enemigos pendientes por spawn
                let enemiesPending = false;
                // En este ejemplo simple, asumimos que todos spawnearon inmediatamente
                // En un juego real, necesitar√≠as llevar cuenta de cu√°ntos han spawnerado
                
                if (!enemiesPending) {
                    gameRunning = false;
                    points += wave * 100;
                    gold += wave * 50;
                    gems += 2;
                    
                    if (wave >= maxWaves) {
                        victory();
                    } else {
                        wave++;
                        waveTimer = 15;
                        waveStatusEl.textContent = `¬°Oleada completada! Siguiente en ${waveTimer}s`;
                        showMessage(`¬°Oleada completada! +${wave*100} puntos, +${wave*50} oro`, "success");
                    }
                    
                    updateUI();
                }
            }
        }
        
        // Mejorar todas las torres
        function upgradeAllTowers() {
            if (gold < 200) {
                showMessage("Necesitas 200 oro", "error");
                return;
            }
            
            if (towers.length === 0) {
                showMessage("No tienes torres", "error");
                return;
            }
            
            gold -= 200;
            towers.forEach(tower => {
                tower.damage *= 1.5;
                tower.range *= 1.1;
                tower.level++;
            });
            
            updateUI();
            showMessage("¬°Todas las torres mejoradas!", "success");
        }
        
        // Vender √∫ltima torre
        function sellLastTower() {
            if (towers.length === 0) {
                showMessage("No tienes torres", "error");
                return;
            }
            
            const tower = towers.pop();
            const refund = Math.floor(tower.cost * 0.75);
            gold += refund;
            
            updateUI();
            showMessage(`Torre vendida por ${refund} oro`, "info");
        }
        
        // Usar poder especial
        function useSpecialPower() {
            if (gems < 10) {
                showMessage("Necesitas 10 gemas", "error");
                return;
            }
            
            gems -= 10;
            let totalBounty = 0;
            
            enemies.forEach(enemy => {
                totalBounty += enemy.bounty;
                enemyKills++;
            });
            
            gold += totalBounty;
            enemies = [];
            
            updateUI();
            showMessage(`¬°Poder especial! +${totalBounty} oro`, "success");
        }
        
        // Comprar √≠tem de tienda
        function buyItem(type, amount, cost) {
            if (gems < cost) {
                showMessage(`Necesitas ${cost} gemas`, "error");
                return;
            }
            
            gems -= cost;
            
            switch(type) {
                case 'gold':
                    gold += amount;
                    showMessage(`+${amount} oro comprado`, "success");
                    break;
                case 'lives':
                    lives += amount;
                    showMessage(`+${amount} vidas compradas`, "success");
                    break;
                case 'damage':
                    damageBoostActive = true;
                    damageBoostEndTime = Date.now() + 30000;
                    showMessage("¬°Boost de x2 da√±o por 30s!", "success");
                    break;
            }
            
            updateUI();
        }
        
        // Victoria
        function victory() {
            gameRunning = false;
            
            document.getElementById('gameOverTitle').textContent = 'üèÜ ¬°VICTORIA!';
            document.getElementById('victoryIcon').textContent = 'üëë';
            document.getElementById('gameOverMessage').textContent = `¬°Has completado las ${maxWaves} oleadas!`;
            document.getElementById('finalScore').textContent = `${points} Puntos`;
            document.getElementById('finalWaves').textContent = wave;
            document.getElementById('finalTowers').textContent = towers.length;
            document.getElementById('finalEnemies').textContent = enemyKills;
            
            gameOverScreen.style.display = 'flex';
        }
        
        // Game Over
        function gameOver() {
            gameRunning = false;
            
            document.getElementById('gameOverTitle').textContent = 'üíÄ GAME OVER';
            document.getElementById('victoryIcon').textContent = 'üò¢';
            document.getElementById('gameOverMessage').textContent = 'Los enemigos invadieron tu reino';
            document.getElementById('finalScore').textContent = `${points} Puntos`;
            document.getElementById('finalWaves').textContent = wave;
            document.getElementById('finalTowers').textContent = towers.length;
            document.getElementById('finalEnemies').textContent = enemyKills;
            
            gameOverScreen.style.display = 'flex';
        }
        
        // Reiniciar juego
        function resetGame() {
            gold = 1000;
            wave = 1;
            lives = 30;
            points = 0;
            gems = 50;
            towers = [];
            enemies = [];
            bullets = [];
            enemyKills = 0;
            gameRunning = false;
            selectedTower = null;
            damageBoostActive = false;
            waveTimer = 0;
            
            gameOverScreen.style.display = 'none';
            updateUI();
            showMessage("¬°Juego reiniciado! Selecciona una torre", "info");
        }
        
        // Continuar juego
        function continueGame() {
            maxWaves = 20;
            gameOverScreen.style.display = 'none';
            showMessage("¬°Modo extendido! Sobrevive hasta oleada 20", "success");
        }
        
        // Compartir puntaje
        function shareScore() {
            const text = `¬°Consegu√≠ ${points} puntos en Kingdom Defense Pro!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Kingdom Defense Pro',
                    text: text
                });
            } else {
                navigator.clipboard.writeText(text);
                showMessage("¬°Puntaje copiado al portapapeles!", "success");
            }
        }
        
        // ============================================
        // INICIALIZACI√ìN Y BUCLE DEL JUEGO
        // ============================================
        
        // Inicializar juego
        function initGame() {
            // Configurar eventos de torres
            document.querySelectorAll('.tower-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.tower-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    
                    this.classList.add('selected');
                    selectedTower = this.dataset.tower;
                    
                    const stats = towerStats[selectedTower];
                    showMessage(`${stats.name} seleccionada (${stats.cost} oro)`, "info");
                });
            });
            
            // Botones
            document.getElementById('startWave').addEventListener('click', startWave);
            document.getElementById('upgradeAll').addEventListener('click', upgradeAllTowers);
            document.getElementById('sellTower').addEventListener('click', sellLastTower);
            document.getElementById('specialPower').addEventListener('click', useSpecialPower);
            
            // Tienda
            document.getElementById('buyGold').addEventListener('click', () => buyItem('gold', 500, 5));
            document.getElementById('buyLives').addEventListener('click', () => buyItem('lives', 10, 8));
            document.getElementById('buyDamage').addEventListener('click', () => buyItem('damage', 0, 15));
            
            // Game over
            document.getElementById('playAgain').addEventListener('click', resetGame);
            document.getElementById('continueGame').addEventListener('click', continueGame);
            document.getElementById('shareScore').addEventListener('click', shareScore);
            
            // Clic en canvas para construir
            canvas.addEventListener('click', (e) => {
                if (!selectedTower) {
                    showMessage("Primero selecciona una torre", "error");
                    return;
                }
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Encontrar la zona de construcci√≥n m√°s cercana
                let targetZone = null;
                let minDistance = Infinity;
                
                for (const zone of buildZones) {
                    const zoneCenterX = zone.x + zone.width/2;
                    const zoneCenterY = zone.y + zone.height/2;
                    const distance = Math.sqrt(
                        Math.pow(x - zoneCenterX, 2) + 
                        Math.pow(y - zoneCenterY, 2)
                    );
                    
                    if (distance < minDistance && distance < 30) {
                        minDistance = distance;
                        targetZone = zone;
                    }
                }
                
                if (targetZone) {
                    // Construir en el centro de la zona
                    const buildX = targetZone.x + targetZone.width/2 - 20;
                    const buildY = targetZone.y + targetZone.height/2 - 20;
                    buildTower(selectedTower, buildX, buildY);
                } else {
                    showMessage("Haz clic en una zona verde para construir", "error");
                }
            });
            
            // Actualizar UI inicial
            updateUI();
            
            // Iniciar bucle del juego
            requestAnimationFrame(gameLoop);
        }
        
        // Bucle principal del juego
        function gameLoop(currentTime) {
            // Actualizar elementos
            updateTowers(currentTime);
            updateGameElements();
            
            // Dibujar
            drawGame();
            
            // Verificar fin de oleada
            checkWaveEnd();
            
            // Actualizar temporizador
            if (waveTimer > 0 && !gameRunning) {
                waveTimer -= 1/60; // 60 FPS
                if (waveTimer <= 0) {
                    waveTimer = 0;
                    waveStatusEl.textContent = "¬°Preparado para la siguiente oleada!";
                }
                updateUI();
            }
            
            // Continuar bucle
            requestAnimationFrame(gameLoop);
        }
        
        // Iniciar cuando el documento est√© listo
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>